<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ULTIMATE CHESS + ONLINE</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC2kE0eAffr3S7tnax0Ym9int4MvNlucg4",
            authDomain: "nouneimlist.firebaseapp.com",
            databaseURL: "https://nouneimlist-default-rtdb.firebaseio.com",
            projectId: "nouneimlist",
            storageBucket: "nouneimlist.firebasestorage.app",
            messagingSenderId: "871712258235",
            appId: "1:871712258235:web:982874240dd587d749119e"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        window.fbAuth = auth;
        window.fbDb = db;
        window.createUser = createUserWithEmailAndPassword;
        window.signIn = signInWithEmailAndPassword;
        window.dbRef = ref;
        window.dbSet = set;
        window.dbOnValue = onValue;
        window.dbUpdate = update;
    </script>

    <style>
        body {
            margin: 0; background: #222; font-family: 'Segoe UI', sans-serif;
            display: flex; justify-content: center; align-items: center; height: 100vh;
            color: white; user-select: none; overflow: hidden;
        }

        /* --- –ù–û–í–û–ï: –≠–ö–†–ê–ù –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò –ò –ö–û–ú–ù–ê–¢ --- */
        #auth-overlay {
            position: absolute; width: 100%; height: 100%; background: #111; z-index: 200;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        .auth-box, .room-box {
            background: #333; padding: 25px; border-radius: 10px; border: 1px solid #555;
            display: flex; flex-direction: column; gap: 10px; width: 300px;
        }
        input { padding: 10px; border-radius: 5px; border: none; }

        /* --- –ú–ï–ù–Æ --- */
        #menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(30, 30, 30, 0.98); z-index: 100;
            display: none; flex-direction: column; justify-content: center; align-items: center;
        }
        h1 { font-size: 50px; margin: 0 0 20px 0; color: #f1c40f; letter-spacing: 5px; text-transform: uppercase; }
        
        .settings-box {
            background: #333; padding: 20px; border-radius: 10px; width: 300px;
            display: flex; flex-direction: column; gap: 15px; border: 1px solid #555;
        }
        .setting-row { display: flex; justify-content: space-between; align-items: center; }
        label { font-size: 16px; cursor: pointer; }
        input[type="checkbox"] { transform: scale(1.5); cursor: pointer; }
        input[type="range"] { width: 100px; cursor: pointer; }

        .btn-start {
            margin-top: 10px; padding: 12px; font-size: 18px; 
            background: #27ae60; color: white; border: none; border-radius: 5px;
            cursor: pointer; transition: 0.2s; font-weight: bold; width: 100%;
        }
        .btn-start:hover { background: #2ecc71; transform: scale(1.02); }

        /* --- –ò–ì–†–ê --- */
        #game-area { display: none; flex-direction: column; align-items: center; width: 100%; height: 100%; }
        
        .chessboard {
            display: grid; 
            border: 5px solid #555; margin-top: 10px;
            background: #111;
        }

        .cell {
            display: flex; justify-content: center; align-items: center;
            font-size: 35px; cursor: pointer; position: relative;
        }
        .cell.small-font { font-size: 20px !important; }

        .white-cell { background-color: #cfd8dc; color: black; }
        .black-cell { background-color: #546e7a; color: white; }
        
        /* –≠–§–§–ï–ö–¢ –°–õ–ï–ü–û–¢–´ */
        .cell.hidden { background-color: #000 !important; color: transparent !important; }
        .cell.hidden * { display: none !important; }

        .selected { background-color: #f39c12 !important; }
        .last-move { background-color: #f1c40f !important; opacity: 0.8; }
        
        .dot {
            width: 30%; height: 30%; background: rgba(0,0,0,0.3);
            border-radius: 50%; position: absolute; pointer-events: none;
        }
        .capture-ring {
            width: 80%; height: 80%; border: 3px solid rgba(192, 57, 43, 0.7);
            border-radius: 50%; position: absolute; pointer-events: none;
        }

        .hp-indicator {
            position: absolute; bottom: 2px; right: 2px;
            font-size: 10px; background: red; color: white;
            padding: 1px 3px; border-radius: 3px; line-height: 1;
        }

        #ui-panel {
            margin-top: 10px; display: flex; gap: 20px; align-items: center;
            background: #333; padding: 10px 20px; border-radius: 8px;
        }
        .turn-indicator { font-size: 20px; font-weight: bold; }
    </style>
</head>
<body>

<div id="auth-overlay">
    <div class="auth-box" id="login-form">
        <h2 style="text-align:center; color:#f1c40f">–í–•–û–î</h2>
        <input type="text" id="auth-login" placeholder="–õ–æ–≥–∏–Ω">
        <input type="password" id="auth-pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button class="btn-start" onclick="handleAuth('login')">–í–æ–π—Ç–∏</button>
        <button class="btn-start" style="background:#2980b9" onclick="handleAuth('reg')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>

    <div class="room-box" id="room-form" style="display:none; margin-top:20px;">
        <h2 style="text-align:center; color:#f1c40f">–ö–û–ú–ù–ê–¢–´</h2>
        <input type="text" id="room-name" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã">
        <input type="password" id="room-pass" placeholder="–ü–∞—Ä–æ–ª—å –∫–æ–º–Ω–∞—Ç—ã">
        <button class="btn-start" style="background:#8e44ad" onclick="createRoom()">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
        <button class="btn-start" style="background:#d35400" onclick="joinRoom()">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
    </div>
</div>

<div id="menu">
    <h1>–®–∞—Ö–º–∞—Ç—ã 2.0</h1>
    <div class="settings-box">
        <div class="setting-row">
            <label for="opt-king">‚ò†Ô∏è –°–º–µ—Ä—Ç—å –ö–æ—Ä–æ–ª—è = –ö–æ–Ω–µ—Ü</label>
            <input type="checkbox" id="opt-king" checked>
        </div>
        <div class="setting-row">
            <label for="opt-blind">üåë –†–µ–∂–∏–º —Å–ª–µ–ø–æ—Ç—ã (3x3)</label>
            <input type="checkbox" id="opt-blind">
        </div>
        <div class="setting-row">
            <label for="opt-board">üåç –ë–æ–ª—å—à–∞—è –¥–æ—Å–∫–∞ (16x16)</label>
            <input type="checkbox" id="opt-board">
        </div>
        <div class="setting-row">
            <label for="opt-special">ü¶Ñ –û—Å–æ–±—ã–µ —Ñ–∏–≥—É—Ä—ã</label>
            <input type="checkbox" id="opt-special">
        </div>
        <div class="setting-row">
            <label>üß† –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç –ò–ò: <span id="ai-val">5</span></label>
            <input type="range" id="opt-ai" min="1" max="10" value="5" oninput="document.getElementById('ai-val').innerText=this.value">
        </div>
        <button class="btn-start" onclick="initGame('w')">–ò–ì–†–ê–¢–¨ (–ë–µ–ª—ã–µ)</button>
        <button class="btn-start" style="background:#8e44ad" onclick="initGame('b')">–ò–ì–†–ê–¢–¨ (–ß–µ—Ä–Ω—ã–µ)</button>
    </div>
</div>

<div id="game-area">
    <div class="chessboard" id="board"></div>
    <div id="ui-panel">
        <div class="turn-indicator" id="status-text">–•–æ–¥ –±–µ–ª—ã—Ö</div>
        <button onclick="location.reload()" style="padding:5px 10px; cursor:pointer;">–ú–µ–Ω—é</button>
    </div>
</div>

<script>
    const config = {
        boardSize: 8,
        kingDeathEnds: true,
        specialPieces: false,
        aiLevel: 5,
        blindMode: false
    };

    let board = [];
    let turn = 'w';
    let playerColor = 'w';
    let selectedIndex = null;
    let possibleMoves = [];
    let gameOver = false;
    let currentUser = null;
    let currentRoom = null;

    const icons = { p: '‚ôü', r: '‚ôú', n: '‚ôû', b: '‚ôù', q: '‚ôõ', k: '‚ôö', s: 'üõ°Ô∏è', w: 'üß±', z: '‚ö°', c: '‚öîÔ∏è' };
    const whiteIcons = { p:'‚ôô', r:'‚ôñ', n:'‚ôò', b:'‚ôó', q:'‚ôï', k:'‚ôî', s:'üõ°Ô∏è', w:'üß±', z:'‚ö°', c:'‚öîÔ∏è' };

    // --- –õ–û–ì–ò–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò –ò Firebase ---
    async function handleAuth(type) {
        const login = document.getElementById('auth-login').value;
        const pass = document.getElementById('auth-pass').value;
        if(login.length < 3) return alert("–õ–æ–≥–∏–Ω —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π");
        const email = `${login}@chess.com`;

        try {
            if(type === 'reg') {
                await window.createUser(window.fbAuth, email, pass);
                alert("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!");
            } else {
                await window.signIn(window.fbAuth, email, pass);
            }
            document.getElementById('login-form').style.display = 'none';
            document.getElementById('room-form').style.display = 'flex';
            currentUser = login;
        } catch (e) { alert(e.message); }
    }

    async function createRoom() {
        const rName = document.getElementById('room-name').value;
        const rPass = document.getElementById('room-pass').value;
        if(!rName) return;
        currentRoom = rName;
        await window.dbSet(window.dbRef(window.fbDb, 'rooms/' + rName), {
            password: rPass,
            creator: currentUser,
            status: 'waiting'
        });
        document.getElementById('auth-overlay').style.display = 'none';
        document.getElementById('menu').style.display = 'flex';
    }

    async function joinRoom() {
        const rName = document.getElementById('room-name').value;
        const rPass = document.getElementById('room-pass').value;
        window.dbOnValue(window.dbRef(window.fbDb, 'rooms/' + rName), (snap) => {
            const data = snap.val();
            if(data && data.password === rPass) {
                currentRoom = rName;
                document.getElementById('auth-overlay').style.display = 'none';
                document.getElementById('menu').style.display = 'flex';
            } else {
                alert("–ù–µ–≤–µ—Ä–Ω–æ–µ –∏–º—è –∫–æ–º–Ω–∞—Ç—ã –∏–ª–∏ –ø–∞—Ä–æ–ª—å");
            }
        }, { onlyOnce: true });
    }

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –ò–ì–†–´ ---
    function initGame(color) {
        config.kingDeathEnds = document.getElementById('opt-king').checked;
        config.boardSize = document.getElementById('opt-board').checked ? 16 : 8;
        config.specialPieces = document.getElementById('opt-special').checked;
        config.blindMode = document.getElementById('opt-blind').checked;
        config.aiLevel = parseInt(document.getElementById('opt-ai').value);
        
        playerColor = color;
        const boardEl = document.getElementById('board');
        const cellSize = config.boardSize === 16 ? 35 : 70;
        boardEl.style.gridTemplateColumns = `repeat(${config.boardSize}, ${cellSize}px)`;
        boardEl.style.gridTemplateRows = `repeat(${config.boardSize}, ${cellSize}px)`;

        createStartBoard();
        document.getElementById('menu').style.display = 'none';
        document.getElementById('game-area').style.display = 'flex';
        
        turn = 'w';
        gameOver = false;
        renderBoard();
        if (playerColor === 'b') setTimeout(aiTurn, 500);
    }

    function createStartBoard() {
        board = new Array(config.boardSize * config.boardSize).fill(null);
        const s = config.boardSize;
        const mk = (t, c, hp=1) => ({ type: t, color: c, hp: hp });

        let row1 = ['r','n','b','q','k','b','n','r'];
        let row2 = new Array(8).fill('p');
        
        if (s === 16) {
            row1 = ['r','n','b','r','n','b','q','k','q','b','n','r','b','n','r','w'];
            row2 = new Array(16).fill('p');
        }

        if (config.specialPieces) {
            if (s === 8) {
                row2[0] = 's'; row2[7] = 's'; row2[3] = 'w'; row2[4] = 'w';
                row1[1] = 'z'; row1[6] = 'c';
            } else {
                row2[0]='s'; row2[15]='s'; row1[0]='z'; row1[15]='c';
            }
        }

        for(let i=0; i<s; i++) {
            if(row1[i]) board[i] = mk(row1[i], 'b', getHP(row1[i]));
            if(row2[i]) board[i + s] = mk(row2[i], 'b', getHP(row2[i]));
        }
        for(let i=0; i<s; i++) {
            if(row2[i]) board[s*(s-2) + i] = mk(row2[i], 'w', getHP(row2[i]));
            if(row1[i]) board[s*(s-1) + i] = mk(row1[i], 'w', getHP(row1[i]));
        }
    }

    function getHP(type) {
        if (type === 's') return 2;
        if (type === 'w') return 3;
        return 1;
    }

    // –õ–û–ì–ò–ö–ê –í–ò–î–ò–ú–û–°–¢–ò (Blindness Mode)
    function isVisible(idx) {
        if (!config.blindMode) return true;
        const s = config.boardSize;
        const r = Math.floor(idx / s);
        const c = idx % s;

        for (let i = 0; i < board.length; i++) {
            if (board[i] && board[i].color === playerColor) {
                const pr = Math.floor(i / s);
                const pc = i % s;
                if (Math.abs(r - pr) <= 1 && Math.abs(c - pc) <= 1) return true;
            }
        }
        return false;
    }

    function renderBoard() {
        const boardEl = document.getElementById('board');
        boardEl.innerHTML = '';
        const s = config.boardSize;

        for (let i = 0; i < s * s; i++) {
            const cell = document.createElement('div');
            let vIdx = playerColor === 'w' ? i : (s*s - 1 - i);
            let piece = board[vIdx];
            let row = Math.floor(vIdx / s);
            let col = vIdx % s;
            
            cell.className = `cell ${(row + col) % 2 === 0 ? 'white-cell' : 'black-cell'}`;
            if (s === 16) cell.classList.add('small-font');
            
            // –ü–†–û–í–ï–†–ö–ê –í–ò–î–ò–ú–û–°–¢–ò
            if (!isVisible(vIdx)) {
                cell.classList.add('hidden');
            } else {
                if (piece) {
                    let ico = piece.color === 'w' ? whiteIcons[piece.type] : icons[piece.type];
                    cell.innerHTML = `<span>${ico}</span>`;
                    if (piece.hp > 1) {
                        const hp = document.createElement('div');
                        hp.className = 'hp-indicator';
                        hp.innerText = piece.hp;
                        cell.appendChild(hp);
                    }
                }
            }

            cell.onclick = () => onCellClick(vIdx);
            if (selectedIndex === vIdx) cell.classList.add('selected');
            if (possibleMoves.includes(vIdx) && isVisible(vIdx)) {
                const mark = document.createElement('div');
                let isAttack = board[vIdx] && board[vIdx].color !== turn;
                mark.className = isAttack ? 'capture-ring' : 'dot';
                cell.appendChild(mark);
            }
            boardEl.appendChild(cell);
        }
        document.getElementById('status-text').innerText = gameOver ? "–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê" : (turn === 'w' ? "–•–æ–¥ –ë–µ–ª—ã—Ö" : "–•–æ–¥ –ß–µ—Ä–Ω—ã—Ö");
    }

    function onCellClick(idx) {
        if (gameOver || turn !== playerColor) return;
        if (possibleMoves.includes(idx)) { doMove(selectedIndex, idx); return; }
        if (board[idx] && board[idx].color === turn) {
            selectedIndex = idx;
            possibleMoves = getMoves(idx, board);
            renderBoard();
        } else {
            selectedIndex = null; possibleMoves = []; renderBoard();
        }
    }

    function doMove(from, to, isAI = false) {
        const attacker = board[from];
        const target = board[to];
        let moveEnd = true;

        if (target) {
            if (target.hp > 1) {
                target.hp -= 1;
                moveEnd = false;
            } else {
                if (config.kingDeathEnds && target.type === 'k') {
                    gameOver = true;
                    alert(`–ö–æ—Ä–æ–ª—å –ø–∞–ª! –ü–æ–±–µ–¥–∞ ${attacker.color === 'w' ? '–ë–µ–ª—ã—Ö' : '–ß–µ—Ä–Ω—ã—Ö'}!`);
                }
            }
        }

        if (moveEnd) { board[to] = attacker; board[from] = null; checkPromotion(to, isAI); }
        selectedIndex = null; possibleMoves = [];
        
        if (!gameOver) {
            turn = turn === 'w' ? 'b' : 'w';
            renderBoard();
            if (turn !== playerColor) setTimeout(aiTurn, 100);
        } else renderBoard();
    }

    function checkPromotion(idx, isAI) {
        const p = board[idx];
        if (p.type !== 'p') return;
        const s = config.boardSize;
        const row = Math.floor(idx / s);
        const endRow = p.color === 'w' ? 0 : s - 1;
        if (row === endRow) {
            if (isAI) p.type = 'q';
            else p.type = prompt("–ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ! q, n, r, b, w, s", "q") || 'q';
        }
    }

    function getMoves(idx, bd) {
        const piece = bd[idx];
        if (!piece) return [];
        const moves = [];
        const s = config.boardSize;
        const r = Math.floor(idx / s);
        const c = idx % s;

        const add = (nr, nc) => {
            if (nr >= 0 && nr < s && nc >= 0 && nc < s) {
                const tIdx = nr * s + nc;
                const target = bd[tIdx];
                if (!target) { moves.push(tIdx); return true; }
                else if (target.color !== piece.color) { moves.push(tIdx); return false; }
                else return false;
            }
            return false;
        };

        const slide = (dr, dc) => {
            for (let k = 1; k < s; k++) { if (!add(r + dr * k, c + dc * k)) break; }
        };

        switch (piece.type) {
            case 'p':
                let d = piece.color === 'w' ? -1 : 1;
                let startR = piece.color === 'w' ? s-2 : 1;
                if (r+d >=0 && r+d < s && !bd[(r+d)*s + c]) {
                    moves.push((r+d)*s + c);
                    if (r === startR && !bd[(r+d*2)*s + c]) moves.push((r+d*2)*s + c);
                }
                if(c>0 && bd[(r+d)*s + c-1] && bd[(r+d)*s + c-1].color !== piece.color) moves.push((r+d)*s + c-1);
                if(c<s-1 && bd[(r+d)*s + c+1] && bd[(r+d)*s + c+1].color !== piece.color) moves.push((r+d)*s + c+1);
                break;
            case 's':
                let d2 = piece.color === 'w' ? -1 : 1;
                if (r+d2 >=0 && r+d2 < s && !bd[(r+d2)*s + c]) moves.push((r+d2)*s + c);
                if(c>0 && bd[(r+d2)*s + c-1] && bd[(r+d2)*s + c-1].color !== piece.color) moves.push((r+d2)*s + c-1);
                if(c<s-1 && bd[(r+d2)*s + c+1] && bd[(r+d2)*s + c+1].color !== piece.color) moves.push((r+d2)*s + c+1);
                break;
            case 'n': [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]].forEach(([dr,dc]) => add(r+dr, c+dc)); break;
            case 'b': [[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr,dc]) => slide(dr,dc)); break;
            case 'r': [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr,dc]) => slide(dr,dc)); break;
            case 'q': [[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr,dc]) => slide(dr,dc)); break;
            case 'k': [[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr,dc]) => add(r+dr, c+dc)); break;
            case 'w': [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr,dc]) => add(r+dr, c+dc)); break;
            case 'z': [[2,2],[2,-2],[-2,2],[-2,-2],[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr,dc]) => add(r+dr, c+dc)); break;
            case 'c': [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr,dc]) => add(r+dr, c+dc)); break;
        }
        return moves;
    }

    function aiTurn() {
        if (gameOver) return;
        const aiColor = playerColor === 'w' ? 'b' : 'w';
        let allMoves = [];
        for(let i=0; i<board.length; i++) {
            if(board[i] && board[i].color === aiColor) {
                let mvs = getMoves(i, board);
                mvs.forEach(to => allMoves.push({from: i, to: to}));
            }
        }
        if (allMoves.length === 0) return;
        let chosenMove = allMoves[Math.floor(Math.random() * allMoves.length)];
        if (config.aiLevel > 2) {
            allMoves.sort((a, b) => (board[b.to] ? getPieceValue(board[b.to].type) : 0) - (board[a.to] ? getPieceValue(board[a.to].type) : 0));
            chosenMove = allMoves[0];
        }
        if (chosenMove) doMove(chosenMove.from, chosenMove.to, true);
    }

    function getPieceValue(t) {
        const vals = { p:10, s:15, z:25, c:25, n:30, b:30, r:50, w:60, q:90, k:900 };
        return vals[t] || 0;
    }
</script>
</body>
</html>



