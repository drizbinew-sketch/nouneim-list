<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nouneim List | Fixed</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --accent: #00ffd4; --bg: #000; --card: rgba(255, 255, 255, 0.07); --text: #fff; }
        body { 
            margin: 0; color: var(--text); font-family: sans-serif; 
            background: linear-gradient(45deg, #000, #1a1a1a, #000);
            background-size: 400% 400%; animation: gradientBG 10s ease infinite;
            min-height: 100vh;
        }
        @keyframes gradientBG { 0% {background-position:0% 50%} 50% {background-position:100% 50%} 100% {background-position:0% 50%} }
        
        .main-logo { font-size: 32px; font-weight: 900; text-align: center; padding: 20px; background: linear-gradient(to right, #00ffd4, #fff, #00ffd4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-size: 200%; animation: shine 3s linear infinite; cursor: pointer;}
        @keyframes shine { to { background-position: 200% center; } }

        nav { display: flex; justify-content: center; gap: 10px; padding: 15px; background: rgba(0,0,0,0.8); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--accent); }
        button { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 8px 15px; cursor: pointer; border-radius: 5px; transition: 0.3s; }
        button:hover { background: var(--accent); color: #000; transform: translateY(-2px); }

        .page { display: none; padding: 20px; max-width: 900px; margin: auto; animation: fadeIn 0.4s; }
        .active { display: block; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        .level-card { background: var(--card); display: flex; align-items: center; margin-bottom: 10px; border-radius: 10px; overflow: hidden; cursor: pointer; border: 1px solid transparent; }
        .level-card:hover { border-color: var(--accent); }
        .lvl-img { width: 120px; height: 70px; object-fit: cover; }
        .lvl-info { padding-left: 15px; }

        .player-row { display: flex; align-items: center; background: var(--card); padding: 10px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; }
        .avatar-small { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 1px solid var(--accent); }

        .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: #111; border: 2px solid var(--accent); padding: 20px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        
        input { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; background: #222; border: 1px solid #444; color: #fff; border-radius: 5px; }
        
        /* Блицкриг стили */
        .blitz-node { background: var(--accent); color: #000; padding: 5px 12px; border-radius: 4px; font-weight: bold; cursor: help; user-select: none; }
        .stage-box { background: var(--card); border: 1px solid #333; padding: 15px; border-radius: 10px; margin-top: 15px; }
        .stage-locked { opacity: 0.3; pointer-events: none; filter: grayscale(1); }
        .blitz-btn { margin: 5px; background: #222; border: 1px solid #444; color: #fff; transition: 0.3s; }
        .blitz-btn.active { background: #28a745; border-color: #28a745; }

        #notifBox { position: fixed; bottom: 20px; left: 20px; z-index: 9999; }
        .notif { background: var(--accent); color: #000; padding: 10px; border-radius: 5px; margin-top: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div class="main-logo" onclick="checkSecretAdmin()">NOUNEIM-LIST</div>
<div id="notifBox"></div>

<nav>
    <button onclick="showPage('levelsPage')">Уровни</button>
    <button onclick="showPage('playersPage')">Игроки</button>
    <button onclick="showPage('blitzPage')">Блицкриг</button>
    <button onclick="showPage('authPage')">Аккаунт</button>
</nav>

<div id="levelsPage" class="page active">
    <div id="levelsList"></div>
</div>

<div id="playersPage" class="page">
    <select id="playerSort" onchange="renderPlayers()" style="width:100%; margin-bottom:15px; padding:10px; background:#111; color:#fff; border:1px solid var(--accent);">
        <option value="pts">Топ по баллам</option>
        <option value="rep">Топ по репутации</option>
    </select>
    <div id="playersList"></div>
</div>

<div id="blitzPage" class="page">
    <div id="blitzAdminZone" style="display:none; background: var(--card); padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid var(--accent);">
        <h3>Создание Блицкрига (Админ)</h3>
        <input type="text" id="blitzNewTitle" placeholder="Название уровня">
        <input type="number" id="blitzNewNode" placeholder="Введите число 1-100" onkeydown="if(event.key==='Enter') addNode()">
        <div id="nodesPreview" style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:10px"></div>
        <button onclick="saveBlitzLevel()" style="width:100%">СОЗДАТЬ БЛИЦКРИГ</button>
    </div>

    <div id="blitzSelection">
        <h3>Выбрать уровень:</h3>
        <select id="blitzLevelSelect" onchange="initBlitzGame()" style="width:100%; padding:10px; background:#111; color:#fff; border:1px solid var(--accent);"></select>
    </div>

    <div id="blitzGameField" style="margin-top:20px"></div>
</div>

<div id="authPage" class="page">
    <div id="authForm">
        <input type="text" id="logN" placeholder="Никнейм">
        <input type="password" id="logP" placeholder="Пароль">
        <button onclick="handleAuth('login')">Войти</button>
        <button onclick="handleAuth('reg')">Регистрация</button>
    </div>
    <div id="profileArea" style="display:none; text-align: center;">
        <img id="myAv" src="" style="width:120px; height:120px; border-radius:50%; border:2px solid var(--accent); cursor:pointer" onclick="document.getElementById('avFile').click()">
        <input type="file" id="avFile" style="display:none" onchange="uploadAvatar(this)">
        <h2 id="myNameDisplay"></h2>
        <div id="adminBadge" style="color:var(--accent); font-weight:bold; display:none">ADMINISTRATOR</div>
        <hr>
        <button onclick="openModal('recModal')" style="background:var(--accent); color:#000; width:100%">ОТПРАВИТЬ РЕКОРД</button>
        <button onclick="logout()" style="color:red; margin-top:10px; border-color:red">Выйти</button>
    </div>
</div>

<div id="lvlModal" class="overlay" onclick="closeModal('lvlModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <h2 id="mLvlTitle"></h2>
        <div id="videoContainer"></div>
        <div id="mLvlRecs" style="margin-top:20px"></div>
    </div>
</div>

<div id="playerModal" class="overlay" onclick="closeModal('playerModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <div style="text-align:center">
            <img id="pAv" src="" style="width:80px; height:80px; border-radius:50%">
            <h2 id="pName"></h2>
            <p id="pRepDisplay"></p>
            <button onclick="vote(1)">+ Респект</button>
            <button onclick="vote(-1)">- Дизлайк</button>
            <button onclick="openChat()">Чат</button>
        </div>
        <hr>
        <div id="pRecords"></div>
    </div>
</div>

<div id="chatModal" class="overlay" onclick="closeModal('chatModal')">
    <div class="modal" onclick="event.stopPropagation()" style="display:flex; flex-direction:column; height:70vh">
        <h3 id="chatWith">Чат</h3>
        <div id="chatMsgs" style="flex-grow:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column"></div>
        <div style="display:flex; gap:5px">
            <input type="text" id="chatInp" style="margin:0">
            <button onclick="sendMsg()">></button>
        </div>
    </div>
</div>

<div id="recModal" class="overlay" onclick="closeModal('recModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <h3>Отправить рекорд</h3>
        <input type="text" id="rLvl" placeholder="Название уровня">
        <input type="number" id="rPerc" placeholder="Проценты">
        <input type="text" id="rVid" placeholder="Ссылка на видео (YouTube)">
        <button onclick="submitRec()">Отправить</button>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC2kE0eAffr3S7tnax0Ym9int4MvNlucg4",
        authDomain: "nouneimlist.firebaseapp.com",
        databaseURL: "https://nouneimlist-default-rtdb.firebaseio.com",
        projectId: "nouneimlist",
        storageBucket: "nouneimlist.firebasestorage.app",
        messagingSenderId: "871712258235",
        appId: "1:871712258235:web:982874240dd587d749119e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = JSON.parse(sessionStorage.getItem('user')) || null;
    let allUsers = {}, levels = {}, blitzLevels = {};

    db.ref('users').on('value', s => { 
        allUsers = s.val() || {}; 
        renderPlayers(); 
        if(user) { 
            user = allUsers[user.name]; 
            updateAccountUI(); 
        } 
    });
    db.ref('levels').on('value', s => { levels = s.val() || {}; renderLevels(); });
    db.ref('blitz').on('value', s => { 
        blitzLevels = s.val() || {}; 
        updateBlitzSelect(); 
    });

    // --- АДМИНКА И ВХОД ---
    function handleAuth(mode) {
        const n = document.getElementById('logN').value.trim();
        const p = document.getElementById('logP').value;
        const secretAdminPass = "Q8484Uhrjrrjj(kfvlp )f";

        if(mode === 'reg') {
            if(allUsers[n]) return alert("Ник занят");
            let role = (p === secretAdminPass) ? 'admin' : 'user';
            db.ref('users/'+n).set({name:n, pass:p, rep:0, role: role});
            alert("Зарегистрирован как " + role);
        } else {
            const u = allUsers[n];
            if(u && u.pass === p) {
                sessionStorage.setItem('user', JSON.stringify(u));
                location.reload();
            } else alert("Ошибка!");
        }
    }

    function updateAccountUI() {
        if(!user) return;
        document.getElementById('authForm').style.display = 'none';
        document.getElementById('profileArea').style.display = 'block';
        document.getElementById('myNameDisplay').innerText = user.name;
        document.getElementById('myAv').src = user.avatar || 'https://i.imgur.com/6VBx3io.png';
        if(user.role === 'admin') {
            document.getElementById('adminBadge').style.display = 'block';
            document.getElementById('blitzAdminZone').style.display = 'block';
        }
    }

    // --- РЕПУТАЦИЯ (ТОЛЬКО 1 РАЗ) ---
    function vote(val) {
        if(!user) return alert("Войди!");
        const target = document.getElementById('pName').innerText;
        if(user.name === target) return alert("Нельзя себе!");

        const voteKey = `votes/${user.name}/${target}`;
        db.ref(voteKey).once('value', s => {
            if(s.exists()) return alert("Вы уже меняли репутацию этому игроку!");
            
            db.ref('users/'+target+'/rep').transaction(c => (c||0) + val);
            db.ref(voteKey).set(true);
            alert("Голос принят");
        });
    }

    // --- БЛИЦКРИГ (ЛОГИКА) ---
    let tempNodes = [];
    function addNode() {
        const val = parseInt(document.getElementById('blitzNewNode').value);
        if(val > 0 && val <= 100 && !tempNodes.includes(val)) {
            tempNodes.push(val);
            tempNodes.sort((a,b)=>a-b);
            renderTempNodes();
        }
        document.getElementById('blitzNewNode').value = "";
    }
    function renderTempNodes() {
        const div = document.getElementById('nodesPreview');
        div.innerHTML = "";
        tempNodes.forEach(n => {
            const span = document.createElement('span');
            span.className = 'blitz-node';
            span.innerText = n;
            span.oncontextmenu = (e) => { e.preventDefault(); tempNodes = tempNodes.filter(x => x!==n); renderTempNodes(); };
            div.appendChild(span);
        });
    }
    function saveBlitzLevel() {
        const title = document.getElementById('blitzNewTitle').value;
        if(!title || tempNodes.length === 0) return alert("Название и числа!");
        db.ref('blitz/'+title).set({title, nodes: tempNodes});
        tempNodes = []; renderTempNodes();
        document.getElementById('blitzNewTitle').value = "";
    }

    function updateBlitzSelect() {
        const sel = document.getElementById('blitzLevelSelect');
        sel.innerHTML = '<option value="">-- Выбери уровень --</option>';
        Object.keys(blitzLevels).forEach(k => {
            sel.innerHTML += `<option value="${k}">${k}</option>`;
        });
    }

    function initBlitzGame() {
        const key = document.getElementById('blitzLevelSelect').value;
        if(!key) return;
        const data = blitzLevels[key];
        const nodes = data.nodes;
        const container = document.getElementById('blitzGameField');
        container.innerHTML = "";

        // Создание стадий
        for(let s = 0; s < nodes.length; s++) {
            const stageDiv = document.createElement('div');
            stageDiv.id = `stage_${s}`;
            stageDiv.className = `stage-box ${s > 0 ? 'stage-locked' : ''}`;
            stageDiv.innerHTML = `<h4>СТАДИЯ ${s+1} (${nodes[s]}%)</h4>`;
            
            const btnWrap = document.createElement('div');
            
            // Расчет интервалов для каждой стадии
            // Пример: если узлы 20 40 60 80
            // Стадия 1 (20%): 0-20, 20-40, 40-80, 80-100
            // Стадия 2 (40%): 0-40, 20-80, 40-100... и т.д.
            
            const currentStep = nodes[s];
            const ranges = [];
            
            // Базовые точки для кнопок: 0, и все узлы
            const points = [0, ...nodes, 100].filter((v, i, a) => a.indexOf(v) === i);
            
            for(let i = 0; i < points.length; i++) {
                let start = points[i];
                let endIdx = i + (nodes.length - s); 
                let end = points[endIdx];
                
                if(end !== undefined) {
                    ranges.push([start, end]);
                }
            }

            ranges.forEach(r => {
                const b = document.createElement('button');
                b.className = 'blitz-btn';
                b.innerText = `${r[0]}% - ${r[1]}%`;
                b.onclick = function() {
                    this.classList.toggle('active');
                    checkStageComplete(s);
                };
                btnWrap.appendChild(b);
            });

            stageDiv.appendChild(btnWrap);
            container.appendChild(stageDiv);
        }
    }

    function checkStageComplete(s) {
        const stage = document.getElementById(`stage_${s}`);
        const btns = stage.querySelectorAll('.blitz-btn');
        const active = stage.querySelectorAll('.blitz-btn.active');

        if(btns.length === active.length) {
            const next = document.getElementById(`stage_${s+1}`);
            if(next) {
                next.classList.remove('stage-locked');
            } else {
                alert("БЛИЦКРИГ ПРОЙДЕН! ПОЗДРАВЛЯЕМ!");
            }
        }
    }

    // --- ОСТАЛЬНЫЕ СТАНДАРТНЫЕ ФУНКЦИИ ---
    function renderLevels() {
        const cont = document.getElementById('levelsList');
        cont.innerHTML = "";
        Object.entries(levels).sort((a,b) => b[1].points - a[1].points).forEach(([id, l], i) => {
            cont.innerHTML += `<div class="level-card" onclick="openLvlModal('${id}')">
                <div style="width:40px; text-align:center">#${i+1}</div>
                <img src="${l.img}" class="lvl-img">
                <div class="lvl-info"><b>${l.name}</b></div>
            </div>`;
        });
    }

    function renderPlayers() {
        const cont = document.getElementById('playersList');
        const sort = document.getElementById('playerSort').value;
        cont.innerHTML = "";
        let arr = Object.values(allUsers).sort((a,b) => sort === 'pts' ? (b.pts||0) - (a.pts||0) : (b.rep||0) - (a.rep||0));
        arr.forEach((p, i) => {
            cont.innerHTML += `<div class="player-row" onclick="openPlayerProfile('${p.name}')">
                <div style="width:30px">#${i+1}</div>
                <img src="${p.avatar || 'https://i.imgur.com/6VBx3io.png'}" class="avatar-small">
                <div><b>${p.name}</b><br><small>REP: ${p.rep || 0}</small></div>
            </div>`;
        });
    }

    function openPlayerProfile(name) {
        const p = allUsers[name];
        document.getElementById('pName').innerText = p.name;
        document.getElementById('pAv').src = p.avatar || 'https://i.imgur.com/6VBx3io.png';
        document.getElementById('pRepDisplay').innerText = "Репутация: " + (p.rep || 0);
        openModal('playerModal');
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function logout() { sessionStorage.clear(); location.reload(); }
    function uploadAvatar(input) {
        const reader = new FileReader();
        reader.onload = e => db.ref('users/'+user.name).update({avatar: e.target.result});
        reader.readAsDataURL(input.files[0]);
    }
</script>
</body>
</html>
