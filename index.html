<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nouneim List | Fixed</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --accent: #00ffd4; --bg: #000; --card: rgba(255, 255, 255, 0.07); --text: #fff; }
        body { 
            margin: 0; color: var(--text); font-family: sans-serif; 
            background: linear-gradient(45deg, #000, #1a1a1a, #000);
            background-size: 400% 400%; animation: gradientBG 10s ease infinite;
            min-height: 100vh;
        }
        @keyframes gradientBG { 0% {background-position:0% 50%} 50% {background-position:100% 50%} 100% {background-position:0% 50%} }
        
        .main-logo { font-size: 32px; font-weight: 900; text-align: center; padding: 20px; background: linear-gradient(to right, #00ffd4, #fff, #00ffd4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-size: 200%; animation: shine 3s linear infinite; }
        @keyframes shine { to { background-position: 200% center; } }

        nav { display: flex; justify-content: center; gap: 10px; padding: 15px; background: rgba(0,0,0,0.8); position: sticky; top: 0; z-index: 100; border-bottom: 1px solid var(--accent); }
        button { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 8px 15px; cursor: pointer; border-radius: 5px; transition: 0.3s; }
        button:hover { background: var(--accent); color: #000; transform: translateY(-2px); }

        .page { display: none; padding: 20px; max-width: 900px; margin: auto; animation: fadeIn 0.4s; }
        .active { display: block; }
        @keyframes fadeIn { from {opacity: 0;} to {opacity: 1;} }

        /* –£—Ä–æ–≤–Ω–∏ */
        .level-card { background: var(--card); display: flex; align-items: center; margin-bottom: 10px; border-radius: 10px; overflow: hidden; cursor: pointer; border: 1px solid transparent; }
        .level-card:hover { border-color: var(--accent); }
        .lvl-img { width: 120px; height: 70px; object-fit: cover; }
        .lvl-info { padding-left: 15px; }

        /* –ò–≥—Ä–æ–∫–∏ */
        .player-row { display: flex; align-items: center; background: var(--card); padding: 10px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; }
        .avatar-small { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 1px solid var(--accent); }

        /* –ú–æ–¥–∞–ª–∫–∏ */
        .overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.9); z-index: 1000; justify-content: center; align-items: center; }
        .modal { background: #111; border: 2px solid var(--accent); padding: 20px; border-radius: 15px; width: 90%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        
        input { width: calc(100% - 22px); padding: 10px; margin-bottom: 10px; background: #222; border: 1px solid #444; color: #fff; border-radius: 5px; }
        #notifBox { position: fixed; bottom: 20px; left: 20px; z-index: 9999; }
        .notif { background: var(--accent); color: #000; padding: 10px; border-radius: 5px; margin-top: 5px; font-weight: bold; }
    </style>
</head>
<body>

<div class="main-logo" onclick="checkSecretAdmin()">NOUNEIM-LIST</div>
<div id="notifBox"></div>

<nav>
    <button onclick="showPage('levelsPage')">–£—Ä–æ–≤–Ω–∏</button>
    <button onclick="showPage('playersPage')">–ò–≥—Ä–æ–∫–∏</button>
    <button onclick="showPage('blitzPage')">–ë–ª–∏—Ü–∫—Ä–∏–≥</button>
    <button onclick="showPage('authPage')">–ê–∫–∫–∞—É–Ω—Ç</button>
</nav>

<div id="levelsPage" class="page active">
    <div id="levelsList"></div>
</div>

<div id="playersPage" class="page">
    <select id="playerSort" onchange="renderPlayers()" style="width:100%; margin-bottom:15px; padding:10px; background:#111; color:#fff; border:1px solid var(--accent);">
        <option value="pts">–¢–æ–ø –ø–æ –±–∞–ª–ª–∞–º</option>
        <option value="rep">–¢–æ–ø –ø–æ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏</option>
    </select>
    <div id="playersList"></div>
</div>

<div id="blitzPage" class="page">
    <div id="blitzSetup" style="background: var(--card); padding: 15px; border-radius: 10px;">
        <h3>–ù–∞—á–∞—Ç—å –ë–ª–∏—Ü–∫—Ä–∏–≥</h3>
        <select id="blitzLevelSelect"><option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å...</option></select>
        <button onclick="startBlitzRun()" style="width: 100%; margin-top: 10px;">–ò–ì–†–ê–¢–¨</button>
    </div>
    <div id="blitzPlayArea" style="display:none; text-align: center; margin-top: 20px;">
        <h2 id="blitzTitle">–£—Ä–æ–≤–µ–Ω—å</h2>
        <h1 id="blitzRange" style="color: var(--accent); font-size: 48px;">0 - 100%</h1>
        <button onclick="nextBlitzStage()" style="padding: 20px 40px; font-size: 20px;">–ì–û–¢–û–í–û</button>
    </div>
</div>

<div id="authPage" class="page">
    <div id="authForm">
        <input type="text" id="logN" placeholder="–ù–∏–∫–Ω–µ–π–º">
        <input type="password" id="logP" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="handleAuth('login')">–í–æ–π—Ç–∏</button>
        <button onclick="handleAuth('reg')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>
    <div id="profileArea" style="display:none; text-align: center;">
        <img id="myAv" src="" style="width:120px; height:120px; border-radius:50%; border:2px solid var(--accent); cursor:pointer" onclick="document.getElementById('avFile').click()">
        <input type="file" id="avFile" style="display:none" onchange="uploadAvatar(this)">
        <h2 id="myNameDisplay"></h2>
        <input type="text" id="newN" placeholder="–ù–æ–≤—ã–π –Ω–∏–∫">
        <button onclick="updateNick()">–°–º–µ–Ω–∏—Ç—å –Ω–∏–∫</button>
        <hr>
        <button onclick="openModal('recModal')" style="background:var(--accent); color:#000; width:100%">–û–¢–ü–†–ê–í–ò–¢–¨ –†–ï–ö–û–†–î</button>
        <button onclick="logout()" style="color:red; margin-top:10px; border-color:red">–í—ã–π—Ç–∏</button>
    </div>
</div>

<div id="lvlModal" class="overlay" onclick="closeModal('lvlModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <h2 id="mLvlTitle"></h2>
        <div id="videoContainer"></div>
        <div id="mLvlRecs" style="margin-top:20px"></div>
    </div>
</div>

<div id="playerModal" class="overlay" onclick="closeModal('playerModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <div style="text-align:center">
            <img id="pAv" src="" style="width:80px; height:80px; border-radius:50%">
            <h2 id="pName"></h2>
            <p id="pRepDisplay"></p>
            <button onclick="vote(1)">+ –†–µ—Å–ø–µ–∫—Ç</button>
            <button onclick="vote(-1)">- –î–∏–∑–ª–∞–π–∫</button>
            <button onclick="openChat()">–ß–∞—Ç</button>
        </div>
        <hr>
        <div id="pRecords"></div>
    </div>
</div>

<div id="chatModal" class="overlay" onclick="closeModal('chatModal')">
    <div class="modal" onclick="event.stopPropagation()" style="display:flex; flex-direction:column; height:70vh">
        <h3 id="chatWith">–ß–∞—Ç</h3>
        <div id="chatMsgs" style="flex-grow:1; overflow-y:auto; padding:10px; display:flex; flex-direction:column"></div>
        <div style="display:flex; gap:5px">
            <input type="text" id="chatInp" style="margin:0">
            <button onclick="sendMsg()">></button>
        </div>
    </div>
</div>

<div id="recModal" class="overlay" onclick="closeModal('recModal')">
    <div class="modal" onclick="event.stopPropagation()">
        <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∫–æ—Ä–¥</h3>
        <input type="text" id="rLvl" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è">
        <input type="number" id="rPerc" placeholder="–ü—Ä–æ—Ü–µ–Ω—Ç—ã">
        <input type="text" id="rVid" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ (YouTube)">
        <button onclick="submitRec()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>
</div>

<script>
    // --- FIREBASE ---
    const firebaseConfig = {
        apiKey: "AIzaSyC2kE0eAffr3S7tnax0Ym9int4MvNlucg4",
        authDomain: "nouneimlist.firebaseapp.com",
        databaseURL: "https://nouneimlist-default-rtdb.firebaseio.com",
        projectId: "nouneimlist",
        storageBucket: "nouneimlist.firebasestorage.app",
        messagingSenderId: "871712258235",
        appId: "1:871712258235:web:982874240dd587d749119e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = JSON.parse(sessionStorage.getItem('user')) || null;
    let allUsers = {}, levels = {}, chats = {};

    // --- –°–õ–£–®–ê–¢–ï–õ–ò ---
    db.ref('users').on('value', s => { allUsers = s.val() || {}; renderPlayers(); if(user) { user = allUsers[user.name]; updateAccountUI(); } });
    db.ref('levels').on('value', s => { levels = s.val() || {}; renderLevels(); updateBlitzList(); });

    // –ü–æ—á–∏–Ω–∫–∞ –≤–∏–¥–µ–æ (–∏–∑–≤–ª–µ—á–µ–Ω–∏–µ ID)
    function getYoutubeID(url) {
        const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
        const match = url.match(regExp);
        return (match && match[2].length === 11) ? match[2] : null;
    }

    // --- –õ–û–ì–ò–ö–ê ---
    function renderLevels() {
        const cont = document.getElementById('levelsList');
        cont.innerHTML = "";
        Object.entries(levels).sort((a,b) => b[1].points - a[1].points).forEach(([id, l], i) => {
            cont.innerHTML += `
                <div class="level-card" onclick="openLvlModal('${id}')">
                    <div style="width:40px; text-align:center">#${i+1}</div>
                    <img src="${l.img}" class="lvl-img">
                    <div class="lvl-info"><b>${l.name}</b></div>
                </div>`;
        });
    }

    function openLvlModal(id) {
        const l = levels[id];
        document.getElementById('mLvlTitle').innerText = l.name;
        const vidId = getYoutubeID(l.video);
        document.getElementById('videoContainer').innerHTML = vidId ? 
            `<iframe width="100%" height="250" src="https://www.youtube.com/embed/${vidId}" frameborder="0" allowfullscreen></iframe>` : '–í–∏–¥–µ–æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ';
        
        let recs = "<h4>–†–µ–∫–æ—Ä–¥—ã:</h4>";
        if(l.records) {
            Object.values(l.records).forEach(r => {
                recs += `<div style="padding:5px; border-bottom:1px solid #333">
                    <span style="color:var(--accent); cursor:pointer" onclick="openPlayerProfile('${r.name}')">${r.name}</span> - ${r.percent}% 
                    <a href="${r.video}" target="_blank" style="color:#fff; text-decoration:none"> [üé¨]</a>
                </div>`;
            });
        }
        document.getElementById('mLvlRecs').innerHTML = recs;
        openModal('lvlModal');
    }

    function renderPlayers() {
        const cont = document.getElementById('playersList');
        const sort = document.getElementById('playerSort').value;
        cont.innerHTML = "";
        
        let arr = Object.values(allUsers).map(u => {
            let pts = 0;
            Object.values(levels).forEach(l => {
                if(l.records) Object.values(l.records).forEach(r => { if(r.name === u.name && r.percent == 100) pts += Number(l.points); });
            });
            return {...u, pts};
        });

        arr.sort((a,b) => sort === 'pts' ? b.pts - a.pts : (b.rep||0) - (a.rep||0));

        arr.forEach((p, i) => {
            cont.innerHTML += `
                <div class="player-row" onclick="openPlayerProfile('${p.name}')">
                    <div style="width:30px">#${i+1}</div>
                    <img src="${p.avatar || 'https://i.imgur.com/6VBx3io.png'}" class="avatar-small">
                    <div>
                        <b>${p.name}</b><br>
                        <small>PTS: ${p.pts} | REP: ${p.rep || 0}</small>
                    </div>
                </div>`;
        });
    }

    // --- –ë–õ–ò–¶–ö–†–ò–ì (0-100% –§–ò–ù–ê–õ) ---
    let blitzStages = [];
    let blitzIndex = 0;
    function updateBlitzList() {
        const sel = document.getElementById('blitzLevelSelect');
        sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —É—Ä–æ–≤–µ–Ω—å...</option>';
        Object.entries(levels).forEach(([id, l]) => { sel.innerHTML += `<option value="${id}">${l.name}</option>`; });
    }

    function startBlitzRun() {
        const id = document.getElementById('blitzLevelSelect').value;
        if(!id) return;
        const l = levels[id];
        const nodes = (l.nodes || "20 40 60 80").split(' ').map(Number).sort((a,b)=>a-b);
        
        blitzStages = [];
        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç–∞–¥–∏–∏
        for(let i=0; i<nodes.length; i++) {
            blitzStages.push(`0 - ${nodes[i]}%`);
            if(i > 0) blitzStages.push(`${nodes[i-1]} - ${nodes[i]}%`);
        }
        blitzStages.push(`0 - 100%`); // –¢–∞ —Å–∞–º–∞—è —Ñ–∏–Ω–∞–ª—å–Ω–∞—è —Å—Ç–∞–¥–∏—è
        
        blitzIndex = 0;
        document.getElementById('blitzTitle').innerText = l.name;
        document.getElementById('blitzSetup').style.display = 'none';
        document.getElementById('blitzPlayArea').style.display = 'block';
        showBlitzStage();
    }

    function showBlitzStage() {
        document.getElementById('blitzRange').innerText = blitzStages[blitzIndex];
    }

    function nextBlitzStage() {
        blitzIndex++;
        if(blitzIndex >= blitzStages.length) {
            alert("–ë–õ–ò–¶–ö–†–ò–ì –ü–†–û–ô–î–ï–ù!");
            document.getElementById('blitzSetup').style.display = 'block';
            document.getElementById('blitzPlayArea').style.display = 'none';
        } else {
            showBlitzStage();
        }
    }

    // --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ò –ü–†–û–§–ò–õ–¨ ---
    function handleAuth(mode) {
        const n = document.getElementById('logN').value.trim();
        const p = document.getElementById('logP').value;
        if(!n || !p) return;

        if(mode === 'reg') {
            if(allUsers[n]) return alert("–ù–∏–∫ –∑–∞–Ω—è—Ç");
            db.ref('users/'+n).set({name:n, pass:p, rep:0, role:'user'});
            alert("–ì–æ—Ç–æ–≤–æ! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏.");
        } else {
            const u = allUsers[n];
            if(u && u.pass === p) {
                sessionStorage.setItem('user', JSON.stringify(u));
                location.reload();
            } else alert("–û—à–∏–±–∫–∞!");
        }
    }

    function updateAccountUI() {
        if(!user) return;
        document.getElementById('authForm').style.display = 'none';
        document.getElementById('profileArea').style.display = 'block';
        document.getElementById('myNameDisplay').innerText = user.name;
        document.getElementById('myAv').src = user.avatar || 'https://i.imgur.com/6VBx3io.png';
    }

    function openPlayerProfile(name) {
        const p = allUsers[name];
        if(!p) return;
        document.getElementById('pName').innerText = p.name;
        document.getElementById('pAv').src = p.avatar || 'https://i.imgur.com/6VBx3io.png';
        document.getElementById('pRepDisplay').innerText = "–†–µ–ø—É—Ç–∞—Ü–∏—è: " + (p.rep || 0);
        openModal('playerModal');
    }

    // --- –ß–ê–¢ ---
    let chatTarget = "";
    function openChat() {
        if(!user) return alert("–í–æ–π–¥–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç");
        chatTarget = document.getElementById('pName').innerText;
        if(chatTarget === user.name) return alert("–° —Å–∞–º–∏–º —Å–æ–±–æ–π?");
        document.getElementById('chatWith').innerText = "–ß–∞—Ç —Å " + chatTarget;
        closeModal('playerModal');
        openModal('chatModal');
        
        const chatId = [user.name, chatTarget].sort().join("_");
        db.ref('chats/' + chatId).on('value', s => {
            const cont = document.getElementById('chatMsgs');
            cont.innerHTML = "";
            s.forEach(m => {
                const msg = m.val();
                const align = msg.from === user.name ? 'flex-end' : 'flex-start';
                const bg = msg.from === user.name ? varAccent() : '#333';
                cont.innerHTML += `<div style="align-self:${align}; background:${bg}; padding:8px; border-radius:10px; margin:2px; max-width:80%; color:#000">${msg.text}</div>`;
            });
            cont.scrollTop = cont.scrollHeight;
        });
    }
    
    function varAccent() { return "#00ffd4"; }

    function sendMsg() {
        const text = document.getElementById('chatInp').value;
        if(!text) return;
        const chatId = [user.name, chatTarget].sort().join("_");
        db.ref('chats/'+chatId).push({ from: user.name, text: text });
        db.ref('notifs/'+chatTarget).set({ from: user.name, type: 'msg' });
        document.getElementById('chatInp').value = "";
    }

    // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    if(user) {
        db.ref('notifs/'+user.name).on('value', s => {
            if(s.exists()) {
                const n = s.val();
                const box = document.getElementById('notifBox');
                box.innerHTML = `<div class="notif">${n.from} —Ç–µ–±–µ –Ω–∞–ø–∏—Å–∞–ª!</div>`;
                setTimeout(() => { box.innerHTML = ""; db.ref('notifs/'+user.name).remove(); }, 4000);
            }
        });
    }

    // –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∞–¥–º–∏–Ω
    function checkSecretAdmin() {
        if(!user) return;
        const code = prompt("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥:");
        if(code === "777") {
            db.ref('users/'+user.name).update({role: 'admin'});
            alert("–¢—ã –∞–¥–º–∏–Ω! –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
        }
    }

    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    function logout() { sessionStorage.clear(); location.reload(); }

    function uploadAvatar(input) {
        const reader = new FileReader();
        reader.onload = e => db.ref('users/'+user.name).update({avatar: e.target.result});
        reader.readAsDataURL(input.files[0]);
    }
</script>
</body>
</html>
