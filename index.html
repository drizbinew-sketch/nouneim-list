<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nouneim List | Blitzkrieg Edition</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { --accent: #00ffd4; --bg: #121212; --card: rgba(30, 30, 30, 0.9); --text: #fff; --admin: #ffaa00; --mod: #0088ff; --ban: #ff4444; }
        body { margin: 0; color: var(--text); font-family: 'Segoe UI', sans-serif; background: #121212; min-height: 100vh; overflow-x: hidden; }
        nav { background: rgba(10, 10, 10, 0.95); padding: 15px; border-bottom: 2px solid var(--accent); display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; position: sticky; top: 0; z-index: 100; }
        button { background: none; border: 2px solid var(--accent); color: var(--accent); padding: 8px 15px; cursor: pointer; font-weight: bold; border-radius: 6px; transition: 0.3s; margin: 2px; }
        button:hover { background: var(--accent); color: #000; }
        button.active-blitz { background: #00ff00 !important; color: #000 !important; border-color: #00ff00 !important; }
        .admin-btn { border-color: var(--admin); color: var(--admin); display: none; }
        .page { display: none; padding: 20px; max-width: 1000px; margin: auto; animation: fadeIn 0.3s; text-align: center; }
        .active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card-item { background: var(--card); border-radius: 12px; display: flex; align-items: center; margin-bottom: 10px; border: 1px solid #333; cursor: pointer; padding: 10px; transition: 0.2s; }
        .card-item:hover { border-color: var(--accent); background: rgba(0, 255, 212, 0.05); }
        .avatar-small { width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 2px solid var(--accent); background: #222; }
        .info { flex-grow: 1; text-align: left; }
        .pts-badge { background: rgba(0,255,212,0.1); color: var(--accent); padding: 5px 12px; border-radius: 6px; font-weight: bold; font-size: 14px; }
        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; align-items: center; justify-content: center; }
        .modal { background: #1a1a1a; padding: 30px; border-radius: 20px; border: 2px solid var(--accent); width: 90%; max-width: 500px; max-height: 85vh; overflow-y: auto; position: relative; }
        input, select { background: #222; border: 1px solid #444; color: #fff; padding: 12px; width: calc(100% - 26px); margin-bottom: 12px; border-radius: 8px; outline: none; }
        input:focus { border-color: var(--accent); }
        
        /* –ë–ª–∏—Ü–∫—Ä–∏–≥ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è */
        .blitz-stage { background: #1a1a1a; border: 2px solid #333; border-radius: 15px; padding: 15px; margin-bottom: 20px; opacity: 0.4; pointer-events: none; transition: 0.5s; }
        .blitz-stage.unlocked { opacity: 1; pointer-events: all; border-color: var(--accent); box-shadow: 0 0 15px rgba(0,255,212,0.2); }
        .blitz-grid { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-top: 10px; }
        .blitz-node { width: 45px; height: 45px; background: #333; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 13px; border: 1px solid #555; }
        .blitz-node:hover { border-color: var(--accent); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border: 1px solid #333; text-align: left; }
        #secretBtn { position: fixed; bottom: 0; right: 0; width: 40px; height: 40px; opacity: 0; cursor: default; z-index: 999; }
    </style>
</head>
<body>

    <nav>
        <button onclick="showPage('levelsPage')">–£—Ä–æ–≤–Ω–∏</button>
        <button onclick="showPage('playersPage')">–ò–≥—Ä–æ–∫–∏</button>
        <button onclick="showPage('blitzPage')">–ë–ª–∏—Ü–∫—Ä–∏–≥</button>
        <button onclick="showPage('authPage')">–ê–∫–∫–∞—É–Ω—Ç</button>
        <button onclick="showPage('adminReqPage')" class="admin-btn" id="btnReq">–†–µ–∫–≤–µ—Å—Ç—ã</button>
        <button onclick="showPage('adminUsersPage')" class="admin-btn" id="btnUsers">–£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
    </nav>

    <div id="blitzPage" class="page">
        <h1>–ë–ª–∏—Ü–∫—Ä–∏–≥</h1>
        <div style="background: var(--card); padding: 20px; border-radius: 15px; margin-bottom: 20px; border: 1px solid #444;">
            <h3>–í—ã–±—Ä–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å</h3>
            <select id="blitzSelect" onchange="loadBlitzGame()">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ë–ª–∏—Ü–∫—Ä–∏–≥...</option>
            </select>
            
            <div id="blitzCreator" class="admin-btn" style="border-top: 1px solid #444; margin-top: 15px; padding-top: 15px;">
                <h3>–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π</h3>
                <input type="text" id="blitzTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è">
                <input type="text" id="blitzPoints" placeholder="–°—Ç–∞—Ä—Ç –ø–æ–∑—ã (–Ω–∞–ø—Ä–∏–º–µ—Ä: 15 30 45 70)">
                <div id="pointChips" class="blitz-grid"></div>
                <button onclick="saveBlitzToDB()" style="width: 100%;">–°–û–•–†–ê–ù–ò–¢–¨ –í –û–ë–õ–ê–ö–û</button>
            </div>
        </div>
        <div id="blitzGameArea"></div>
    </div>

    <div id="levelsPage" class="page active">
        <h1>TOP LEVELS</h1>
        <div id="levelsList"></div>
    </div>

    <div id="playersPage" class="page">
        <h1>–†–µ–π—Ç–∏–Ω–≥ –∏–≥—Ä–æ–∫–æ–≤</h1>
        <div id="playersList"></div>
    </div>

    <div id="adminReqPage" class="page">
        <h1>–†–µ–∫–≤–µ—Å—Ç—ã (–ó–∞—è–≤–∫–∏)</h1>
        <div id="reqList"></div>
    </div>

    <div id="adminUsersPage" class="page">
        <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏</h1>
        <table id="usersTable">
            <thead><tr><th>–ù–∏–∫</th><th>–†–æ–ª—å</th><th>–°—Ç–∞—Ç—É—Å</th><th>–î–µ–π—Å—Ç–≤–∏–µ</th></tr></thead>
            <tbody id="usersTableBody"></tbody>
        </table>
    </div>

    <div id="authPage" class="page">
        <div id="authBox">
            <h1>–í—Ö–æ–¥</h1>
            <input type="text" id="loginInp" placeholder="–õ–æ–≥–∏–Ω"><br>
            <input type="password" id="passInp" placeholder="–ü–∞—Ä–æ–ª—å"><br>
            <button onclick="auth('login')">–í–æ–π—Ç–∏</button>
            <button onclick="auth('reg')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
        <div id="userBox" style="display:none">
            <img id="myAv" src="" class="avatar-small" style="width:120px; height:120px; margin-bottom: 15px;"><br>
            <h1 id="myNick" style="margin: 5px 0;"></h1>
            <p id="myRoleDisplay" style="color: var(--accent); margin-bottom: 20px;"></p>
            
            <div style="background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 10px;">
                <h3>–°–º–µ–Ω–∏—Ç—å –∞–≤–∞—Ç–∞—Ä</h3>
                <input type="file" id="avFile" accept="image/*" style="display:none" onchange="uploadAvatar(this)">
                <button onclick="document.getElementById('avFile').click()">–í—ã–±—Ä–∞—Ç—å —Ñ–∞–π–ª</button>
            </div>
            
            <button onclick="logout()" style="color:var(--ban); border-color:var(--ban)">–í—ã–π—Ç–∏</button>
            <hr>
            <button onclick="openRecordModal()" style="width:100%; background:var(--accent); color:#000">–û–¢–ü–†–ê–í–ò–¢–¨ –†–ï–ö–û–†–î</button>
        </div>
    </div>

    <div id="profileModal" class="overlay" onclick="this.style.display='none'">
        <div class="modal" onclick="event.stopPropagation()">
            <img id="pAv" src="" class="avatar-small" style="width:100px; height:100px; display:block; margin:auto; margin-bottom: 15px;">
            <h2 id="pName"></h2>
            <div id="pRep" style="font-size: 24px; font-weight:bold; margin-bottom: 15px;"></div>
            
            <div id="pActions">
                <button onclick="changeRep(1)" style="color: #00ff00;">–†–µ—Å–ø–µ–∫—Ç +1</button>
                <button onclick="changeRep(-1)" style="color: #ff4444;">–î–∏–∑–ª–∞–π–∫ -1</button>
            </div>

            <div id="adminRepBox" class="admin-btn" style="margin-top: 15px; border-top: 1px solid #444; padding-top: 15px;">
                <p>–ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å —Ä–µ–ø—É—Ç–∞—Ü–∏–∏:</p>
                <input type="number" id="adminRepInp" placeholder="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏–µ">
                <button onclick="setRepAdmin()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
            <hr>
            <div id="pStats" style="text-align: left;"></div>
        </div>
    </div>

    <div id="recModal" class="overlay" onclick="this.style.display='none'">
        <div class="modal" onclick="event.stopPropagation()">
            <h2>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–µ–∫–æ—Ä–¥</h2>
            <input type="text" id="recLvl" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è">
            <input type="number" id="recPerc" placeholder="–ü—Ä–æ—Ü–µ–Ω—Ç (0-100)">
            <input type="text" id="recVid" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ">
            <button onclick="sendRec()" style="width:100%; background: var(--accent); color: #000;">–û–¢–ü–†–ê–í–ò–¢–¨</button>
        </div>
    </div>

    <div id="secretBtn" onclick="secretAdmin()"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC2kE0eAffr3S7tnax0Ym9int4MvNlucg4",
            authDomain: "nouneimlist.firebaseapp.com",
            databaseURL: "https://nouneimlist-default-rtdb.firebaseio.com",
            projectId: "nouneimlist",
            storageBucket: "nouneimlist.firebasestorage.app",
            messagingSenderId: "871712258235",
            appId: "1:871712258235:web:982874240dd587d749119e"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let user = JSON.parse(sessionStorage.getItem('user')) || null;
        let allUsers = {};
        let blitzList = {};
        let levels = [];
        let blitzPoints = [];
        let viewingUser = null;

        // --- –ó–ê–ì–†–£–ó–ö–ê –î–ê–ù–ù–´–• ---
        db.ref('users').on('value', s => { 
            allUsers = s.val() || {}; 
            renderPlayers(); 
            renderUsersTable();
            if(user && allUsers[user.name]) {
                user = allUsers[user.name];
                updateUI();
            }
        });

        db.ref('levels').on('value', s => {
            levels = [];
            s.forEach(c => { levels.push({id: c.key, ...c.val()}); });
            renderLevels();
        });

        db.ref('blitz').on('value', s => {
            blitzList = s.val() || {};
            const sel = document.getElementById('blitzSelect');
            sel.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ë–ª–∏—Ü–∫—Ä–∏–≥...</option>';
            Object.keys(blitzList).forEach(id => {
                sel.innerHTML += `<option value="${id}">${blitzList[id].title}</option>`;
            });
        });

        db.ref('requests').on('value', s => {
            const cont = document.getElementById('reqList');
            if(!cont) return;
            cont.innerHTML = "";
            s.forEach(c => {
                const r = c.val();
                cont.innerHTML += `<div class="card-item">
                    <div class="info"><b>${r.user}</b> -> ${r.level} (${r.percent}%)</div>
                    <button onclick="db.ref('requests/${c.key}').remove()">–£–¥–∞–ª–∏—Ç—å</button>
                </div>`;
            });
        });

        // --- –ë–õ–ò–¶–ö–†–ò–ì –û–ë–õ–ê–ö–û ---
        const bpInp = document.getElementById('blitzPoints');
        bpInp.addEventListener('input', () => {
            const vals = bpInp.value.split(' ').filter(v => v !== "" && v >= 1 && v <= 100);
            blitzPoints = [...new Set(vals)].sort((a,b) => a-b);
            renderBlitzChips();
        });

        function renderBlitzChips() {
            const cont = document.getElementById('pointChips');
            cont.innerHTML = "";
            blitzPoints.forEach(p => {
                const d = document.createElement('div');
                d.className = 'blitz-node';
                d.innerText = p;
                d.oncontextmenu = (e) => { e.preventDefault(); blitzPoints = blitzPoints.filter(x => x !== p); bpInp.value = blitzPoints.join(' '); renderBlitzChips(); };
                cont.appendChild(d);
            });
        }

        function saveBlitzToDB() {
            const title = document.getElementById('blitzTitle').value;
            if(!title || blitzPoints.length === 0) return alert("–ó–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ!");
            db.ref('blitz').push({ title, points: blitzPoints });
            alert("–£—Ä–æ–≤–µ–Ω—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –≤ –æ–±–ª–∞–∫–æ!");
            document.getElementById('blitzTitle').value = "";
            document.getElementById('blitzPoints').value = "";
            blitzPoints = [];
            renderBlitzChips();
        }

        function loadBlitzGame() {
            const id = document.getElementById('blitzSelect').value;
            if(!id) return;
            const data = blitzList[id];
            const cont = document.getElementById('blitzGameArea');
            cont.innerHTML = `<h2>–£—Ä–æ–≤–µ–Ω—å: ${data.title}</h2>`;
            
            const pts = [0, ...data.points, 100];
            const stages = data.points.length;

            for(let s = 1; s <= stages; s++) {
                const stageDiv = document.createElement('div');
                stageDiv.id = `st-${s}`;
                stageDiv.className = `blitz-stage ${s === 1 ? 'unlocked' : ''}`;
                stageDiv.innerHTML = `<h3>–°—Ç–∞–¥–∏—è ${s}</h3><div class="blitz-grid" id="grid-${s}"></div>`;
                cont.appendChild(stageDiv);

                for(let i = 0; i < pts.length - s; i++) {
                    const btn = document.createElement('button');
                    btn.innerText = `${pts[i]}% - ${pts[i+s]}%`;
                    btn.onclick = function() {
                        this.classList.toggle('active-blitz');
                        checkStage(s, stages);
                    };
                    document.getElementById(`grid-${s}`).appendChild(btn);
                }
            }
        }

        function checkStage(s, total) {
            const grid = document.getElementById(`grid-${s}`);
            const btns = grid.querySelectorAll('button');
            const active = grid.querySelectorAll('.active-blitz');
            if(btns.length === active.length) {
                if(s < total) document.getElementById(`st-${s+1}`).classList.add('unlocked');
                else alert("–ë–õ–ò–¶–ö–†–ò–ì –ü–†–û–ô–î–ï–ù! üéâ");
            }
        }

        // --- –ê–í–ê–¢–ê–† –§–ê–ô–õ ---
        function uploadAvatar(input) {
            const file = input.files[0];
            if(!file || file.size > 500000) return alert("–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π (–º–∞–∫—Å 500–∫–±)");
            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result;
                db.ref('users/'+user.name).update({ avatar: base64 });
                alert("–ê–≤–∞—Ç–∞—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!");
            };
            reader.readAsDataURL(file);
        }

        // --- –†–ï–ü–£–¢–ê–¶–ò–Ø ---
        function changeRep(val) {
            if(!user) return alert("–í–æ–π–¥–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç!");
            if(user.name === viewingUser) return alert("–ù–µ–ª—å–∑—è –º–µ–Ω—è—Ç—å —Å–µ–±–µ!");
            const votePath = `votes/${viewingUser}/${user.name}`;
            db.ref(votePath).once('value', s => {
                if(s.exists()) return alert("–í—ã —É–∂–µ –≥–æ–ª–æ—Å–æ–≤–∞–ª–∏ –∑–∞ —ç—Ç–æ–≥–æ –∏–≥—Ä–æ–∫–∞!");
                const newRep = (allUsers[viewingUser].rep || 0) + val;
                db.ref('users/'+viewingUser).update({ rep: newRep });
                db.ref(votePath).set(val);
                openProfile(viewingUser);
            });
        }

        function setRepAdmin() {
            const val = parseInt(document.getElementById('adminRepInp').value);
            if(isNaN(val)) return;
            db.ref('users/'+viewingUser).update({ rep: val });
            alert("–†–µ–ø—É—Ç–∞—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω–æ–º!");
            openProfile(viewingUser);
        }

        // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–û–ï ---
        function secretAdmin() {
            if(prompt("–°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–æ–¥:") === "admin_ultra") {
                db.ref('users/'+user.name).update({role: 'admin'});
                location.reload();
            }
        }

        function auth(mode) {
            const n = document.getElementById('loginInp').value;
            const p = document.getElementById('passInp').value;
            if(mode === 'reg') {
                if(allUsers[n]) return alert("–ù–∏–∫ –∑–∞–Ω—è—Ç!");
                db.ref('users/'+n).set({name:n, pass:p, role:'user', banned:false, rep:0, avatar:''});
            } else {
                const u = allUsers[n];
                if(u && u.pass === p) {
                    user = u;
                    sessionStorage.setItem('user', JSON.stringify(user));
                    location.reload();
                } else alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞!");
            }
        }

        function sendRec() {
            const lvl = document.getElementById('recLvl').value;
            const prc = document.getElementById('recPerc').value;
            if(!lvl || !prc) return;
            db.ref('requests').push({ user: user.name, level: lvl, percent: prc });
            alert("–†–µ–∫–æ—Ä–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É!");
            document.getElementById('recModal').style.display='none';
        }

        function renderPlayers() {
            const cont = document.getElementById('playersList');
            if(!cont) return;
            cont.innerHTML = "";
            const sorted = Object.values(allUsers).sort((a,b) => (b.rep||0) - (a.rep||0));
            sorted.forEach(p => {
                cont.innerHTML += `<div class="card-item" onclick="openProfile('${p.name}')">
                    <img src="${p.avatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png'}" class="avatar-small">
                    <div class="info"><b>${p.name}</b></div>
                    <div class="pts-badge">${p.rep || 0} REP</div>
                </div>`;
            });
        }

        function openProfile(name) {
            viewingUser = name;
            const u = allUsers[name];
            document.getElementById('pName').innerText = name;
            document.getElementById('pAv').src = u.avatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
            document.getElementById('pRep').innerText = (u.rep || 0) + " REP";
            document.getElementById('pRep').style.color = (u.rep||0) >= 0 ? "#00ff00" : "#ff4444";
            document.getElementById('profileModal').style.display = 'flex';
        }

        function renderLevels() {
            const cont = document.getElementById('levelsList');
            cont.innerHTML = "";
            levels.forEach(l => {
                cont.innerHTML += `<div class="card-item" style="cursor:default">
                    <div class="info"><b>${l.name}</b></div>
                    <div class="pts-badge">${l.points} PTS</div>
                </div>`;
            });
        }

        function renderUsersTable() {
            const body = document.getElementById('usersTableBody');
            if(!body) return;
            body.innerHTML = "";
            Object.keys(allUsers).forEach(id => {
                const u = allUsers[id];
                body.innerHTML += `<tr>
                    <td>${u.name}</td>
                    <td>${u.role}</td>
                    <td>${u.banned ? '–ë–ê–ù' : 'OK'}</td>
                    <td><button onclick="if(confirm('–£–¥–∞–ª–∏—Ç—å?')) db.ref('users/${u.name}').remove()" style="color:red">–£–î–ê–õ–ò–¢–¨</button></td>
                </tr>`;
            });
        }

        function updateUI() {
            if(user) {
                document.getElementById('authBox').style.display = 'none';
                document.getElementById('userBox').style.display = 'block';
                document.getElementById('myNick').innerText = user.name;
                document.getElementById('myAv').src = user.avatar || 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
                document.getElementById('myRoleDisplay').innerText = "–°—Ç–∞—Ç—É—Å: " + user.role.toUpperCase();
                if(user.role === 'admin') {
                    document.querySelectorAll('.admin-btn').forEach(b => b.style.display = 'block');
                }
            }
        }

        function showPage(id) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }
        function logout() { sessionStorage.clear(); location.reload(); }
        function openRecordModal() { document.getElementById('recModal').style.display = 'flex'; }

        updateUI();
    </script>
</body>
</html>
