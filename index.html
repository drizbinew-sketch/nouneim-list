<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>ULTIMATE CHESS</title>
    <style>
        body {
            margin: 0; background: #222; font-family: 'Segoe UI', sans-serif;
            display: flex; justify-content: center; align-items: center; height: 100vh;
            color: white; user-select: none; overflow: hidden;
        }

        /* --- –ú–ï–ù–Æ --- */
        #menu {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(30, 30, 30, 0.98); z-index: 100;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        h1 { font-size: 50px; margin: 0 0 20px 0; color: #f1c40f; letter-spacing: 5px; text-transform: uppercase; }
        
        .auth-box {
            background: #2b2b2b; padding: 12px 16px; border-radius: 8px; margin-bottom: 14px;
            display: flex; gap: 10px; align-items: center; border: 1px solid #444;
        }
        .auth-box input { padding:6px 8px; border-radius:4px; border:1px solid #555; background:#222; color:white }
        .auth-box button { padding:8px 10px; border-radius:4px; border:none; cursor:pointer }

        .settings-box {
            background: #333; padding: 20px; border-radius: 10px; width: 300px;
            display: flex; flex-direction: column; gap: 15px; border: 1px solid #555;
        }
        .setting-row { display: flex; justify-content: space-between; align-items: center; }
        label { font-size: 16px; cursor: pointer; }
        input[type="checkbox"] { transform: scale(1.2); cursor: pointer; }
        input[type="range"] { width: 100px; cursor: pointer; }

        .btn-start {
            margin-top: 20px; padding: 15px 40px; font-size: 22px; 
            background: #27ae60; color: white; border: none; border-radius: 5px;
            cursor: pointer; transition: 0.2s; font-weight: bold; width: 100%;
        }
        .btn-start:hover { background: #2ecc71; transform: scale(1.02); }

        /* --- –ò–ì–†–ê --- */
        #game-area { display: none; flex-direction: column; align-items: center; width: 100%; height: 100%; }
        
        .chessboard {
            display: grid; 
            /* Grid template –∑–∞–¥–∞–µ—Ç—Å—è —á–µ—Ä–µ–∑ JS */
            border: 5px solid #555; margin-top: 10px;
            background: #111;
        }

        .cell {
            display: flex; justify-content: center; align-items: center;
            font-size: 35px; cursor: pointer; position: relative;
        }
        /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
        .cell.small-font { font-size: 20px !important; }

        .white-cell { background-color: #cfd8dc; color: black; }
        .black-cell { background-color: #546e7a; color: white; }
        
        .selected { background-color: #f39c12 !important; }
        .last-move { background-color: #f1c40f !important; opacity: 0.8; }
        
        .dot {
            width: 30%; height: 30%; background: rgba(0,0,0,0.3);
            border-radius: 50%; position: absolute; pointer-events: none;
        }
        .capture-ring {
            width: 80%; height: 80%; border: 3px solid rgba(192, 57, 43, 0.7);
            border-radius: 50%; position: absolute; pointer-events: none;
        }

        /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∂–∏–∑–Ω–µ–π */
        .hp-indicator {
            position: absolute; bottom: 2px; right: 2px;
            font-size: 10px; background: red; color: white;
            padding: 1px 3px; border-radius: 3px; line-height: 1;
        }

        #ui-panel {
            margin-top: 10px; display: flex; gap: 20px; align-items: center;
            background: #333; padding: 10px 20px; border-radius: 8px;
        }
        .turn-indicator { font-size: 20px; font-weight: bold; }

        /* Fog / Blind mode */
        .fog {
            background: #000 !important; color: #000 !important; cursor: default !important;
        }

        /* Room UI inside menu */
        .room-box { background:#2d2d2d; padding:10px; border-radius:8px; margin-top:10px; border:1px solid #444; width:300px; display:flex; flex-direction:column; gap:8px }
        .room-box input { padding:6px; border-radius:4px; border:1px solid #555; background:#222; color:white }
        .room-box button { padding:8px; border-radius:4px; border:none; cursor:pointer }

    </style>
</head>
<body>

<div id="menu">
    <h1>–®–∞—Ö–º–∞—Ç—ã 2.0</h1>

    <!-- AUTH / REGISTRATION TOP -->
    <div class="auth-box">
        <input id="login-username" placeholder="–õ–æ–≥–∏–Ω" />
        <input id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" type="password" />
        <button id="register-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        <button id="login-btn">–í—Ö–æ–¥</button>
    </div>

    <div class="settings-box">
        <div class="setting-row">
            <label for="opt-king">‚ò†Ô∏è –°–º–µ—Ä—Ç—å –ö–æ—Ä–æ–ª—è = –ö–æ–Ω–µ—Ü</label>
            <input type="checkbox" id="opt-king" checked>
        </div>
        <div class="setting-row">
            <label for="opt-board">üåç –ë–æ–ª—å—à–∞—è –¥–æ—Å–∫–∞ (16x16)</label>
            <input type="checkbox" id="opt-board">
        </div>
        <div class="setting-row">
            <label for="opt-special">ü¶Ñ –û—Å–æ–±—ã–µ —Ñ–∏–≥—É—Ä—ã</label>
            <input type="checkbox" id="opt-special">
        </div>
        <div class="setting-row">
            <label for="opt-blind">üåë –†–µ–∂–∏–º —Å–ª–µ–ø–æ—Ç—ã (—Ç—É–º–∞–Ω –≤–æ–π–Ω—ã)</label>
            <input type="checkbox" id="opt-blind">
        </div>
        <div class="setting-row">
            <label>üß† –ò–Ω—Ç–µ–ª–ª–µ–∫—Ç –ò–ò: <span id="ai-val">5</span></label>
            <input type="range" id="opt-ai" min="1" max="10" value="5" oninput="document.getElementById('ai-val').innerText=this.value">
        </div>
        <button class="btn-start" onclick="initGame('w')">–ò–ì–†–ê–¢–¨ (–ë–µ–ª—ã–µ)</button>
        <button class="btn-start" style="background:#8e44ad" onclick="initGame('b')">–ò–ì–†–ê–¢–¨ (–ß–µ—Ä–Ω—ã–µ)</button>
    </div>

    <!-- ROOM CREATION / JOIN -->
    <div class="room-box">
        <input id="room-name" placeholder="–ò–º—è –∫–æ–º–Ω–∞—Ç—ã" />
        <div style="display:flex; gap:8px;">
            <button id="create-room-btn">–°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É</button>
            <button id="join-room-btn">–ü—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è</button>
        </div>
        <small style="color:#bbb">–ü—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏/–≤—Ö–æ–¥–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è –±—ã—Ç—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω—ã–º (–ª–æ–≥–∏–Ω/–ø–∞—Ä–æ–ª—å —Å–≤–µ—Ä—Ö—É). –õ–æ–≥–∏–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.</small>
    </div>

</div>

<div id="game-area">
    <div class="chessboard" id="board"></div>
    <div id="ui-panel">
        <div class="turn-indicator" id="status-text">–•–æ–¥ –±–µ–ª—ã—Ö</div>
        <button onclick="location.reload()" style="padding:5px 10px; cursor:pointer;">–ú–µ–Ω—é</button>
    </div>
</div>

<!-- FIREBASE (module) - –¥–æ–±–∞–≤–ª–µ–Ω–æ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –∏–≥—Ä–æ–≤–æ–≥–æ –∫–æ–¥–∞ -->
<script type="module">
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ–¥—É–ª—å–Ω—ã–π SDK Firebase (–±—Ä–∞—É–∑–µ—Ä). –ù–µ–±–æ–ª—å—à–∞—è –æ–±—ë—Ä—Ç–∫–∞ - —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –ø—Ä–æ—Å—Ç—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ window.
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC2kE0eAffr3S7tnax0Ym9int4MvNlucg4",
      authDomain: "nouneimlist.firebaseapp.com",
      databaseURL: "https://nouneimlist-default-rtdb.firebaseio.com",
      projectId: "nouneimlist",
      storageBucket: "nouneimlist.firebasestorage.app",
      messagingSenderId: "871712258235",
      appId: "1:871712258235:web:982874240dd587d749119e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // –ü—Ä–æ—Å—Ç–∞—è –∫–æ–Ω–≤–µ–Ω—Ü–∏—è: –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –ª–æ–≥–∏–Ω (–±–µ–∑ @) –∏ –º—ã –¥–æ–±–∞–≤–ª—è–µ–º —Å—É—Ñ—Ñ–∏–∫—Å –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è email –ø—Ä–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏.
    const EMAIL_DOMAIN = '@ultimatechess.local';

    window.registerUser = async (username, password) => {
        if (!username || !password) throw new Error('–õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');
        const email = username + EMAIL_DOMAIN;
        const cred = await createUserWithEmailAndPassword(auth, email, password);
        // –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å displayName
        return cred.user;
    };

    window.loginUser = async (username, password) => {
        if (!username || !password) throw new Error('–õ–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã');
        const email = username + EMAIL_DOMAIN;
        const cred = await signInWithEmailAndPassword(auth, email, password);
        return cred.user;
    };

    // –°–æ–∑–¥–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É: —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ –∫–ª—é—á—É –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–º–µ–Ω–∏
    window.createRoom = async (roomName) => {
        if (!auth.currentUser) throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É');
        if (!roomName) throw new Error('–ò–º—è –∫–æ–º–Ω–∞—Ç—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
        const key = encodeURIComponent(roomName);
        await set(ref(db, 'rooms/' + key), {
            name: roomName,
            ownerUid: auth.currentUser.uid,
            ownerName: auth.currentUser.email ? auth.currentUser.email.split('@')[0] : 'anon',
            createdAt: Date.now()
        });
        return key;
    };

    window.joinRoom = async (roomName) => {
        if (!auth.currentUser) throw new Error('–¢—Ä–µ–±—É–µ—Ç—Å—è –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É');
        if (!roomName) throw new Error('–ò–º—è –∫–æ–º–Ω–∞—Ç—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ');
        const key = encodeURIComponent(roomName);
        const snap = await get(ref(db, 'rooms/' + key));
        if (!snap.exists()) throw new Error('–ö–æ–º–Ω–∞—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
        return snap.val();
    };

    // –î–∏–Ω–∞–º–∏–∫–∞ UI –≤ –º–µ–Ω—é (–ø–æ–¥–∫–ª—é—á–∞–µ–º —Å–ª—É—à–∞—Ç–µ–ª–µ–π)
    onAuthStateChanged(auth, user => {
        window.currentUser = user || null;
        const input = document.getElementById('login-username');
        if (user) {
            // –ø–æ–¥—Å—Ç–∞–≤–∏–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (email –±–µ–∑ –¥–æ–º–µ–Ω–∞)
            try { input.value = user.email.split('@')[0]; } catch(e) {}
        }
    });

</script>

<script>
    // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
    const config = {
        boardSize: 8,
        kingDeathEnds: true,
        specialPieces: false,
        aiLevel: 5,
        blindMode: false // –¥–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è —Ä–µ–∂–∏–º–∞ —Å–ª–µ–ø–æ—Ç—ã
    };

    let board = []; // –ú–∞—Å—Å–∏–≤ —Å–æ—Å—Ç–æ—è–Ω–∏—è: { type: 'r', color: 'w', hp: 1, id: 'wP' }
    let turn = 'w';
    let playerColor = 'w';
    let selectedIndex = null;
    let possibleMoves = [];
    let gameOver = false;

    // –ò–∫–æ–Ω–∫–∏
    const icons = {
        // –°—Ç–∞–Ω–¥–∞—Ä—Ç
        p: '‚ôü', r: '‚ôú', n: '‚ôû', b: '‚ôù', q: '‚ôõ', k: '‚ôö',
        // –û—Å–æ–±—ã–µ
        s: 'üõ°Ô∏è', // –©–∏—Ç–æ–Ω–æ—Å–µ—Ü (Shield)
        w: 'üß±', // –°—Ç–µ–Ω–∞ (Wall)
        z: '‚ö°', // –ó–∏–≥–∑–∞–≥ (Zigzag/Zeus)
        c: '‚öîÔ∏è'  // –ö—Ä—É–≥–æ–≤–∏–∫ (Commander/Circle)
    };

    const whiteIcons = { p:'‚ôô', r:'‚ôñ', n:'‚ôò', b:'‚ôó', q:'‚ôï', k:'‚ôî', s:'üõ°Ô∏è', w:'üß±', z:'‚ö°', c:'‚öîÔ∏è' };

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
    function initGame(color) {
        // –ß—Ç–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫
        config.kingDeathEnds = document.getElementById('opt-king').checked;
        config.boardSize = document.getElementById('opt-board').checked ? 16 : 8;
        config.specialPieces = document.getElementById('opt-special').checked;
        config.aiLevel = parseInt(document.getElementById('opt-ai').value);
        config.blindMode = document.getElementById('opt-blind').checked;
        
        playerColor = color;
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–µ—Ç–∫–∏ CSS
        const boardEl = document.getElementById('board');
        const cellSize = config.boardSize === 16 ? 35 : 70; // –£–º–µ–Ω—å—à–∞–µ–º –∫–ª–µ—Ç–∫–∏ –¥–ª—è –±–æ–ª—å—à–æ–π –¥–æ—Å–∫–∏
        boardEl.style.gridTemplateColumns = `repeat(${config.boardSize}, ${cellSize}px)`;
        boardEl.style.gridTemplateRows = `repeat(${config.boardSize}, ${cellSize}px)`;

        createStartBoard();
        
        document.getElementById('menu').style.display = 'none';
        document.getElementById('game-area').style.display = 'flex';
        
        turn = 'w';
        gameOver = false;
        renderBoard();

        if (playerColor === 'b') setTimeout(aiTurn, 500);
    }

    function createStartBoard() {
        board = new Array(config.boardSize * config.boardSize).fill(null);
        const s = config.boardSize;

        // –ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ñ–∏–≥—É—Ä—ã: —Ç–∏–ø, —Ü–≤–µ—Ç, –∂–∏–∑–Ω–∏
        const mk = (t, c, hp=1) => ({ type: t, color: c, hp: hp });

        // –ê—Ä–º–∏–∏
        const backRow = ['r','n','b','q','k','b','n','r'];
        
        // –ï—Å–ª–∏ 16x16, —Ä–∞—Å—à–∏—Ä—è–µ–º –∞—Ä–º–∏—é
        let row1, row2; 
        if (s === 16) {
            // –¶–µ–Ω—Ç—Ä —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π, –∫—Ä–∞—è –∑–∞–ø–æ–ª–Ω—è–µ–º –ª–∞–¥—å—è–º–∏ –∏ –∫–æ–Ω—è–º–∏
            row1 = ['r','n','b','r','n','b','q','k','q','b','n','r','b','n','r','w'];
            row2 = new Array(16).fill('p');
        } else {
            row1 = [...backRow];
            row2 = new Array(8).fill('p');
        }

        // –í—Å—Ç–∞–≤–∫–∞ –æ—Å–æ–±—ã—Ö —Ñ–∏–≥—É—Ä, –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω–æ
        if (config.specialPieces) {
            if (s === 8) {
                // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—à–∫–∏ –Ω–∞ —â–∏—Ç—ã –∏ —Ç.–¥.
                row2[0] = 's'; row2[7] = 's'; row2[3] = 'w'; row2[4] = 'w';
                row1[1] = 'z'; row1[6] = 'c'; // –ó–∞–º–µ–Ω—è–µ–º –∫–æ–Ω–µ–π –Ω–∞ —Å–ø–µ—Ü
            } else {
                // –î–ª—è 16x16 –ø—Ä–æ—Å—Ç–æ –¥–æ–±–∞–≤–∏–º –∏—Ö
                row2[0]='s'; row2[1]='s'; row2[14]='s'; row2[15]='s';
                row1[0]='z'; row1[15]='c';
                row2[7]='w'; row2[8]='w';
            }
        }

        // –†–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –ß–µ—Ä–Ω—ã—Ö (—Å–≤–µ—Ä—Ö—É)
        for(let i=0; i<s; i++) {
            if(row1[i]) board[i] = mk(row1[i], 'b', getHP(row1[i]));
            if(row2[i]) board[i + s] = mk(row2[i], 'b', getHP(row2[i]));
        }

        // –†–∞—Å—Å—Ç–∞–Ω–æ–≤–∫–∞ –ë–µ–ª—ã—Ö (—Å–Ω–∏–∑—É)
        for(let i=0; i<s; i++) {
            if(row2[i]) board[s*(s-2) + i] = mk(row2[i], 'w', getHP(row2[i]));
            if(row1[i]) board[s*(s-1) + i] = mk(row1[i], 'w', getHP(row1[i]));
        }
    }

    function getHP(type) {
        if (type === 's') return 2; // –©–∏—Ç
        if (type === 'w') return 3; // –°—Ç–µ–Ω–∞
        return 1;
    }

    // --- –û–¢–†–ò–°–û–í–ö–ê ---
    function renderBoard() {
        const boardEl = document.getElementById('board');
        boardEl.innerHTML = '';
        const s = config.boardSize;

        // –í—ã—á–∏—Å–ª—è–µ–º –≤–∏–¥–∏–º—ã–µ –∫–ª–µ—Ç–∫–∏, –µ—Å–ª–∏ —Ä–µ–∂–∏–º —Å–ª–µ–ø–æ—Ç—ã –≤–∫–ª—é—á—ë–Ω
        let visibleSet = new Set();
        if (config.blindMode) {
            for (let i = 0; i < board.length; i++) {
                const p = board[i];
                if (p && p.color === playerColor) {
                    const rr = Math.floor(i / s);
                    const cc = i % s;
                    for (let dr = -1; dr <= 1; dr++) {
                        for (let dc = -1; dc <= 1; dc++) {
                            const nr = rr + dr;
                            const nc = cc + dc;
                            if (nr >= 0 && nr < s && nc >= 0 && nc < s) visibleSet.add(nr * s + nc);
                        }
                    }
                }
            }
        }

        for (let i = 0; i < s * s; i++) {
            const cell = document.createElement('div');
            // –í–∏–∑—É–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ–≤–æ—Ä–æ—Ç –¥–ª—è —á–µ—Ä–Ω—ã—Ö
            let vIdx = playerColor === 'w' ? i : (s*s - 1 - i);
            let piece = board[vIdx];
            
            let row = Math.floor(vIdx / s);
            let col = vIdx % s;
            
            cell.className = `cell ${(row + col) % 2 === 0 ? 'white-cell' : 'black-cell'}`;
            if (s === 16) cell.classList.add('small-font');
            
            // –ö–ª–∏–∫ –¥–æ–ª–∂–µ–Ω –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è, –µ—Å–ª–∏ –∫–ª–µ—Ç–∫–∞ –≤ —Ä–µ–∂–∏–º–µ —Å–ª–µ–ø–æ—Ç—ã –Ω–µ –≤–∏–¥–Ω–∞
            cell.onclick = () => {
                if (config.blindMode && !visibleSet.has(vIdx)) return; // –Ω–µ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–∞
                onCellClick(vIdx);
            };

            // –ï—Å–ª–∏ —Ä–µ–∂–∏–º —Å–ª–µ–ø–æ—Ç—ã –∏ –∫–ª–µ—Ç–∫–∞ –ù–ï –≤–∏–¥–Ω–∞, —Å–∫—Ä—ã–≤–∞–µ–º –µ—ë –ø–æ–ª–Ω–æ—Å—Ç—å—é
            if (config.blindMode && !visibleSet.has(vIdx)) {
                cell.classList.add('fog');
            } else {
                if (piece) {
                    // –í—ã–±–æ—Ä –∏–∫–æ–Ω–∫–∏
                    let ico = piece.color === 'w' ? whiteIcons[piece.type] : icons[piece.type];
                    cell.innerHTML = `<span>${ico}</span>`;
                    
                    // –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä HP –µ—Å–ª–∏ > 1
                    if (piece.hp > 1) {
                        const hp = document.createElement('div');
                        hp.className = 'hp-indicator';
                        hp.innerText = piece.hp;
                        cell.appendChild(hp);
                    }
                }

                // –ü–æ–¥—Å–≤–µ—Ç–∫–∞
                if (selectedIndex === vIdx) cell.classList.add('selected');
                if (possibleMoves.includes(vIdx)) {
                    const mark = document.createElement('div');
                    let isAttack = board[vIdx] && board[vIdx].color !== turn;
                    mark.className = isAttack ? 'capture-ring' : 'dot';
                    cell.appendChild(mark);
                }
            }

            boardEl.appendChild(cell);
        }
        
        document.getElementById('status-text').innerText = gameOver ? "–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê" : (turn === 'w' ? "–•–æ–¥ –ë–µ–ª—ã—Ö" : "–•–æ–¥ –ß–µ—Ä–Ω—ã—Ö");
    }

    // --- –õ–û–ì–ò–ö–ê ---
    function onCellClick(idx) {
        if (gameOver || turn !== playerColor) return;

        // –ï—Å–ª–∏ –∫–ª–∏–∫ –ø–æ —Ç–æ—á–∫–µ —Ö–æ–¥–∞
        if (possibleMoves.includes(idx)) {
            doMove(selectedIndex, idx);
            return;
        }

        // –í—ã–±–æ—Ä —Ñ–∏–≥—É—Ä—ã
        if (board[idx] && board[idx].color === turn) {
            selectedIndex = idx;
            possibleMoves = getMoves(idx, board);
            renderBoard();
        } else {
            selectedIndex = null;
            possibleMoves = [];
            renderBoard();
        }
    }

    function doMove(from, to, isAI = false) {
        const attacker = board[from];
        const target = board[to];
        let moveEnd = true; // –û–±—ã—á–Ω–æ —Ö–æ–¥ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ–º

        // –õ–æ–≥–∏–∫–∞ –ê–¢–ê–ö–ò
        if (target) {
            // –ï—Å–ª–∏ —É —Ü–µ–ª–∏ –µ—Å—Ç—å HP > 1 (–©–∏—Ç, –°—Ç–µ–Ω–∞)
            if (target.hp > 1) {
                target.hp -= 1; // –°–Ω–∏–º–∞–µ–º –∂–∏–∑–Ω—å
                moveEnd = false; // –ê—Ç–∞–∫—É—é—â–∏–π –ù–ï –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –Ω–∞ –∫–ª–µ—Ç–∫—É (—Ä–∏–∫–æ—à–µ—Ç)
                // –ù–æ —Ö–æ–¥ –∑–∞—Å—á–∏—Ç—ã–≤–∞–µ—Ç—Å—è –∫–∞–∫ —Å–¥–µ–ª–∞–Ω–Ω—ã–π
            } else {
                // –û–±—ã—á–Ω–æ–µ —É–±–∏–π—Å—Ç–≤–æ
                if (config.kingDeathEnds && target.type === 'k') {
                    gameOver = true;
                    alert(`–ö–æ—Ä–æ–ª—å ${target.color === 'w' ? '–ë–µ–ª—ã—Ö' : '–ß–µ—Ä–Ω—ã—Ö'} –ø–∞–ª! –ü–æ–±–µ–¥–∞ ${attacker.color === 'w' ? '–ë–µ–ª—ã—Ö' : '–ß–µ—Ä–Ω—ã—Ö'}!`);
                }
            }
        }

        if (moveEnd) {
            board[to] = attacker;
            board[from] = null;
            
            // –ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ –ø–µ—à–∫–∏
            checkPromotion(to, isAI);
        }

        // –°–±—Ä–æ—Å
        selectedIndex = null;
        possibleMoves = [];
        
        if (!gameOver) {
            turn = turn === 'w' ? 'b' : 'w';
            renderBoard();
            
            // –ï—Å–ª–∏ —Å–µ–π—á–∞—Å —Ö–æ–¥ –ò–ò
            if (turn !== playerColor) {
                setTimeout(aiTurn, 100);
            }
        } else {
            renderBoard();
        }
    }

    function checkPromotion(idx, isAI) {
        const p = board[idx];
        if (p.type !== 'p') return;
        
        const s = config.boardSize;
        const row = Math.floor(idx / s);
        const endRow = p.color === 'w' ? 0 : s - 1;

        if (row === endRow) {
            if (isAI) {
                p.type = 'q'; // –ò–ò –≤—Å–µ–≥–¥–∞ –±–µ—Ä–µ—Ç —Ñ–µ—Ä–∑—è
            } else {
                let newType = prompt("–ü—Ä–µ–≤—Ä–∞—â–µ–Ω–∏–µ! –í–≤–µ–¥–∏—Ç–µ –±—É–∫–≤—É: q (–§–µ—Ä–∑—å), n (–ö–æ–Ω—å), r (–õ–∞–¥—å—è), b (–°–ª–æ–Ω), w (–°—Ç–µ–Ω–∞)", "q");
                const map = {'q':'q', 'n':'n', 'r':'r', 'b':'b', 'w':'w', 's':'s'};
                p.type = map[newType && newType.toLowerCase()] || 'q';
            }
        }
    }

    // --- –ì–ï–ù–ï–†–ê–¢–û–† –•–û–î–û–í ---
    function getMoves(idx, bd) {
        const piece = bd[idx];
        if (!piece) return [];
        const moves = [];
        const s = config.boardSize;
        const r = Math.floor(idx / s);
        const c = idx % s;

        const add = (nr, nc) => {
            if (nr >= 0 && nr < s && nc >= 0 && nc < s) {
                const tIdx = nr * s + nc;
                const target = bd[tIdx];
                if (!target) {
                    moves.push(tIdx);
                    return true; // continue sliding
                } else if (target.color !== piece.color) {
                    moves.push(tIdx); // capture
                    return false; // stop sliding
                } else {
                    return false; // blocked by friend
                }
            }
            return false;
        };

        const slide = (dr, dc, limit = 99) => {
            for (let k = 1; k <= limit; k++) {
                if (!add(r + dr * k, c + dc * k)) break;
            }
        };

        switch (piece.type) {
            case 'p': // –ü–µ—à–∫–∞
                let d = piece.color === 'w' ? -1 : 1;
                let startR = piece.color === 'w' ? s-2 : 1; // –£—á–µ—Ç —Ä–∞–∑–º–µ—Ä–∞ –¥–æ—Å–∫–∏
                // –•–æ–¥ –≤–ø–µ—Ä–µ–¥
                if (r+d >=0 && r+d < s && !bd[(r+d)*s + c]) {
                    moves.push((r+d)*s + c);
                    if (r === startR && !bd[(r+d*2)*s + c]) moves.push((r+d*2)*s + c);
                }
                // –ê—Ç–∞–∫–∞
                if(c>0 && bd[(r+d)*s + c-1] && bd[(r+d)*s + c-1].color !== piece.color) moves.push((r+d)*s + c-1);
                if(c<s-1 && bd[(r+d)*s + c+1] && bd[(r+d)*s + c+1].color !== piece.color) moves.push((r+d)*s + c+1);
                break;
            case 's': // –©–∏—Ç (–∫–∞–∫ –ø–µ—à–∫–∞, –Ω–æ –±–µ–∑ –¥–≤–æ–π–Ω–æ–≥–æ —Ö–æ–¥–∞, –∑–∞—Ç–æ –∂–∏—Ä–Ω—ã–π)
                let d2 = piece.color === 'w' ? -1 : 1;
                if (r+d2 >=0 && r+d2 < s && !bd[(r+d2)*s + c]) moves.push((r+d2)*s + c);
                // –ë—å–µ—Ç –∫–∞–∫ –ø–µ—à–∫–∞
                if(c>0 && bd[(r+d2)*s + c-1] && bd[(r+d2)*s + c-1].color !== piece.color) moves.push((r+d2)*s + c-1);
                if(c<s-1 && bd[(r+d2)*s + c+1] && bd[(r+d2)*s + c+1].color !== piece.color) moves.push((r+d2)*s + c+1);
                break;
            case 'n': // –ö–æ–Ω—å
                [[2,1],[2,-1],[-2,1],[-2,-1],[1,2],[1,-2],[-1,2],[-1,-2]].forEach(([dr,dc]) => add(r+dr, c+dc));
                break;
            case 'b': // –°–ª–æ–Ω
                [[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr,dc]) => slide(dr,dc));
                break;
            case 'r': // –õ–∞–¥—å—è
                [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr,dc]) => slide(dr,dc));
                break;
            case 'q': // –§–µ—Ä–∑—å
                [[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr,dc]) => slide(dr,dc));
                break;
            case 'k': // –ö–æ—Ä–æ–ª—å
                [[0,1],[0,-1],[1,0],[-1,0],[1,1],[1,-1],[-1,1],[-1,-1]].forEach(([dr,dc]) => add(r+dr, c+dc));
                break;
            
            // --- –°–ü–ï–¶ –§–ò–ì–£–†–´ ---
            case 'w': // –°—Ç–µ–Ω–∞ (—Ö–æ–¥–∏—Ç –∫–∞–∫ –∫–æ—Ä–æ–ª—å, –Ω–æ –æ–æ–æ—á–µ–Ω—å –º–µ–¥–ª–µ–Ω–Ω–æ, —Ç–æ–ª—å–∫–æ –æ—Ä—Ç–æ–≥–æ–Ω–∞–ª—å–Ω–æ)
                 [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr,dc]) => add(r+dr, c+dc));
                 break;
            case 'z': // –ó–∏–≥–∑–∞–≥ (–ó–µ–≤—Å) - –¥–∏–∞–≥–æ–Ω–∞–ª—å —á–µ—Ä–µ–∑ 1 –∫–ª–µ—Ç–∫—É (–∫–∞–∫ —Å–ª–æ–Ω, –Ω–æ –ø—Ä—ã–≥–∞–µ—Ç)
                [[2,2],[2,-2],[-2,2],[-2,-2]].forEach(([dr,dc]) => add(r+dr, c+dc));
                // –ò –∫–æ—Ä–æ—Ç–∫–∏–π —Ö–æ–¥ –æ—Ä—Ç–æ–≥–æ–Ω–∞–ª—å–Ω–æ
                [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr,dc]) => add(r+dr, c+dc));
                break;
            case 'c': // –ö—Ä—É–≥–æ–≤–∏–∫ (Commander) - "–ö—Ä—É–≥ 3x3 –±–µ–∑ —É–≥–ª–æ–≤" = –ö—Ä–µ—Å—Ç –Ω–∞ 1 –∫–ª–µ—Ç–∫—É
                [[0,1],[0,-1],[1,0],[-1,0]].forEach(([dr,dc]) => add(r+dr, c+dc));
                break;
        }
        return moves;
    }

    // --- –ò–°–ö–£–°–°–¢–í–ï–ù–ù–´–ô –ò–ù–¢–ï–õ–õ–ï–ö–¢ ---
    function aiTurn() {
        if (gameOver) return;
        
        const aiColor = playerColor === 'w' ? 'b' : 'w';
        let allMoves = [];

        // 1. –°–±–æ—Ä –≤—Å–µ—Ö —Ö–æ–¥–æ–≤
        for(let i=0; i<board.length; i++) {
            if(board[i] && board[i].color === aiColor) {
                let mvs = getMoves(i, board);
                mvs.forEach(to => allMoves.push({from: i, to: to}));
            }
        }

        if (allMoves.length === 0) return; // –ü–∞—Ç –∏–ª–∏ –º–∞—Ç

        let chosenMove = null;

        // –õ–û–ì–ò–ö–ê –ü–û –£–†–û–í–ù–Ø–ú
        if (config.aiLevel <= 2) {
            // –£—Ä–æ–≤–µ–Ω—å 1-2: –ü–æ–ª–Ω—ã–π —Ä–∞–Ω–¥–æ–º
            chosenMove = allMoves[Math.floor(Math.random() * allMoves.length)];
        } 
        else if (config.aiLevel <= 6) {
            // –£—Ä–æ–≤–µ–Ω—å 3-6: –ñ–∞–¥–Ω—ã–π (–±—å–µ—Ç, –µ—Å–ª–∏ –º–æ–∂–µ—Ç)
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —Ö–æ–¥—ã –ø–æ —Ü–µ–Ω–Ω–æ—Å—Ç–∏ –∂–µ—Ä—Ç–≤—ã
            allMoves.sort((a, b) => {
                let valA = board[a.to] ? getPieceValue(board[a.to].type) : 0;
                let valB = board[b.to] ? getPieceValue(board[b.to].type) : 0;
                return valB - valA;
            });
            // –ë–µ—Ä–µ–º –ª—É—á—à–∏–π, –Ω–æ —Å –Ω–µ–±–æ–ª—å—à–∏–º —à–∞–Ω—Å–æ–º –æ—à–∏–±–∫–∏ –¥–ª—è —Ä–µ–∞–ª–∏–∑–º–∞
            chosenMove = allMoves[0];
            if (config.aiLevel < 6 && Math.random() > 0.7) {
                chosenMove = allMoves[Math.floor(Math.random() * Math.min(3, allMoves.length))];
            }
        } 
        else {
            // –£—Ä–æ–≤–µ–Ω—å 7-10: –ü—Ä–æ—Å—á–µ—Ç –æ—Ç–≤–µ—Ç–∞ (Minimax –≥–ª—É–±–∏–Ω—ã 1 —Å –æ—Ü–µ–Ω–∫–æ–π –ø–æ–∑–∏—Ü–∏–∏)
            let bestScore = -99999;
            
            // –ï—Å–ª–∏ —Ö–æ–¥–æ–≤ —Å–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ (16x16), –æ–±—Ä–µ–∑–∞–µ–º –ø–æ–∏—Å–∫
            let candidates = allMoves;
            if (candidates.length > 50) candidates = candidates.sort(() => 0.5 - Math.random()).slice(0, 50);

            candidates.forEach(move => {
                // –°–∏–º—É–ª—è—Ü–∏—è —Ö–æ–¥–∞
                let savedTo = board[move.to];
                let savedFrom = board[move.from];
                
                // –≠–º—É–ª—è—Ü–∏—è –≤–∑—è—Ç–∏—è
                let moveScore = 0;
                if (savedTo) moveScore += getPieceValue(savedTo.type) * 10;
                
                board[move.to] = savedFrom;
                board[move.from] = null;

                // –û—Ç–≤–µ—Ç–Ω—ã–π —É–¥–∞—Ä –∏–≥—Ä–æ–∫–∞?
                let maxPlayerResponse = 0;
                // –û—á–µ–Ω—å —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –º–æ–∂–µ—Ç –ª–∏ –∏–≥—Ä–æ–∫ —Å—ä–µ—Å—Ç—å —ç—Ç—É —Ñ–∏–≥—É—Ä—É —Ç–µ–ø–µ—Ä—å?
                // (–ü–æ–ª–Ω—ã–π –ø–µ—Ä–µ–±–æ—Ä —Å–ª–∏—à–∫–æ–º —Ç—è–∂–µ–ª –¥–ª—è JS –≤ –æ–¥–Ω–æ–º –ø–æ—Ç–æ–∫–µ –Ω–∞ –±–æ–ª—å—à–æ–π –¥–æ—Å–∫–µ)
                if (config.aiLevel === 10) {
                    // –¢—É—Ç –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ª–æ–∂–Ω—É—é –ª–æ–≥–∏–∫—É, –Ω–æ –¥–ª—è –±—Ä–∞—É–∑–µ—Ä–∞ –æ–≥—Ä–∞–Ω–∏—á–∏–º—Å—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∫–æ–π
                    // –®—Ç—Ä–∞—Ñ –µ—Å–ª–∏ –ø–æ–¥—Å—Ç–∞–≤–ª—è–µ–º—Å—è –ø–æ–¥ –±–æ–π
                }

                board[move.from] = savedFrom;
                board[move.to] = savedTo;
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Å–ª—É—á–∞–π–Ω–æ—Å—Ç—å
                moveScore += Math.random() * 2;

                if (moveScore > bestScore) {
                    bestScore = moveScore;
                    chosenMove = move;
                }
            });
        }

        if (chosenMove) {
            doMove(chosenMove.from, chosenMove.to, true);
        }
    }

    function getPieceValue(t) {
        const vals = { p:10, s:15, z:25, c:25, n:30, b:30, r:50, w:60, q:90, k:900 };
        return vals[t] || 0;
    }

    // --- BIND MENU ACTIONS FOR AUTH/ROOMS (–¥–æ–±–∞–≤–ª–µ–Ω–æ) ---
    document.getElementById('register-btn').addEventListener('click', async () => {
        const u = document.getElementById('login-username').value.trim();
        const p = document.getElementById('login-password').value;
        try {
            await window.registerUser(u, p);
            alert('–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∏ –≤–æ—à—ë–ª: ' + u);
        } catch (e) { alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + e.message); }
    });

    document.getElementById('login-btn').addEventListener('click', async () => {
        const u = document.getElementById('login-username').value.trim();
        const p = document.getElementById('login-password').value;
        try {
            await window.loginUser(u, p);
            alert('–í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω: ' + u);
        } catch (e) { alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + e.message); }
    });

    document.getElementById('create-room-btn').addEventListener('click', async () => {
        const rn = document.getElementById('room-name').value.trim();
        try {
            const key = await window.createRoom(rn);
            alert('–ö–æ–º–Ω–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∞: ' + rn + ' (–∫–ª—é—á: ' + key + ')');
        } catch (e) { alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫–æ–º–Ω–∞—Ç—ã: ' + e.message); }
    });

    document.getElementById('join-room-btn').addEventListener('click', async () => {
        const rn = document.getElementById('room-name').value.trim();
        try {
            const data = await window.joinRoom(rn);
            alert('–í—Ö–æ–¥ –≤ –∫–æ–º–Ω–∞—Ç—É: ' + rn + '\n–í–ª–∞–¥–µ–ª–µ—Ü: ' + data.ownerName);
        } catch (e) { alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –≤ –∫–æ–º–Ω–∞—Ç—É: ' + e.message); }
    });

</script>
</body>
</html>



