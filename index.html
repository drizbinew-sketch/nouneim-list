<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nouneim List | Final Edition</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <style>
        :root { 
            --accent: #00ffd4; 
            --bg-dark: #000; 
            --bg-light: #222;
            --card: rgba(255, 255, 255, 0.05);
            --text: #fff;
        }

        /* –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω */
        body { 
            margin: 0; 
            color: var(--text); 
            font-family: 'Inter', 'Segoe UI', sans-serif; 
            background: linear-gradient(45deg, #000, #222, #000);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            min-height: 100vh;
            overflow-x: hidden;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* –ü–µ—Ä–µ–ª–∏–≤–∞—é—â–∏–π—Å—è –∑–∞–≥–æ–ª–æ–≤–æ–∫ */
        .main-logo {
            font-size: 42px;
            font-weight: 900;
            text-align: center;
            padding: 20px;
            background: linear-gradient(to right, #00ffd4, #fff, #00ffd4);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-size: 200% auto;
            animation: shine 3s linear infinite;
        }

        @keyframes shine { to { background-position: 200% center; } }

        nav { 
            background: rgba(0, 0, 0, 0.8); 
            backdrop-filter: blur(10px);
            padding: 15px; 
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; 
            position: sticky; top: 0; z-index: 100; 
        }

        button { 
            background: rgba(255,255,255,0.05); border: 1px solid var(--accent); 
            color: var(--accent); padding: 10px 20px; cursor: pointer; 
            font-weight: 600; border-radius: 8px; transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); 
        }

        button:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,255,212,0.3); background: var(--accent); color: #000; }

        .page { display: none; padding: 20px; max-width: 1100px; margin: auto; animation: slideUp 0.5s ease-out; }
        .active { display: block; }

        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ —É—Ä–æ–≤–Ω–µ–π */
        .level-card {
            background: var(--card); border-radius: 15px; margin-bottom: 15px;
            display: flex; align-items: center; border: 1px solid rgba(255,255,255,0.1);
            overflow: hidden; transition: 0.3s; cursor: pointer; position: relative;
        }
        .level-card:hover { background: rgba(255,255,255,0.1); border-color: var(--accent); }
        .lvl-rank { width: 50px; font-size: 24px; font-weight: bold; color: var(--accent); text-align: center; }
        .lvl-img { width: 150px; height: 85px; object-fit: cover; }
        .lvl-info { padding: 0 20px; flex-grow: 1; text-align: left; }

        /* –ß–∞—Ç */
        #chatWindow {
            background: #111; border: 2px solid var(--accent); border-radius: 20px;
            width: 90%; max-width: 600px; height: 70vh; display: flex; flex-direction: column;
        }
        #chatMessages { flex-grow: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 10px 15px; border-radius: 12px; max-width: 70%; position: relative; }
        .msg.my { align-self: flex-end; background: var(--accent); color: #000; }
        .msg.other { align-self: flex-start; background: #333; color: #fff; }

        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        #notifBox { position: fixed; left: 20px; bottom: 20px; z-index: 999; }
        .notif-item { background: var(--accent); color: #000; padding: 10px 20px; border-radius: 8px; margin-top: 5px; animation: slideIn 0.3s; }

        @keyframes slideIn { from { transform: translateX(-100%); } to { transform: translateX(0); } }

        .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal { background: #000; border: 2px solid var(--accent); padding: 30px; border-radius: 20px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; }
        
        input, select { background: #111; border: 1px solid #333; color: #fff; padding: 12px; width: calc(100% - 26px); margin-bottom: 10px; border-radius: 10px; }
        
        .admin-controls { margin-top: 15px; padding-top: 15px; border-top: 1px dotted var(--accent); }
    </style>
</head>
<body>
    <div class="main-logo">NOUNEIM-LIST</div>
    <div id="notifBox"></div>

    <nav>
        <button onclick="showPage('levelsPage')">–£—Ä–æ–≤–Ω–∏</button>
        <button onclick="showPage('playersPage')">–ò–≥—Ä–æ–∫–∏</button>
        <button onclick="showPage('blitzPage')">–ë–ª–∏—Ü–∫—Ä–∏–≥</button>
        <button onclick="showPage('authPage')">–ê–∫–∫–∞—É–Ω—Ç</button>
        <button id="adminReqBtn" style="display:none" onclick="showPage('adminReqPage')">–†–µ–∫–≤–µ—Å—Ç—ã</button>
        <button id="adminUsersBtn" style="display:none" onclick="showPage('adminUsersPage')">–£—á–∞—Å—Ç–Ω–∏–∫–∏</button>
    </nav>

    <div id="levelsPage" class="page active">
        <div id="levelsList"></div>
    </div>

    <div id="playersPage" class="page">
        <div style="margin-bottom: 20px;">
            <span>–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞: </span>
            <select id="playerSort" onchange="renderPlayers()" style="width: 200px;">
                <option value="pts">–ü–æ –±–∞–ª–ª–∞–º</option>
                <option value="hardest">–ü–æ —Ö–∞—Ä–¥–µ—Å—Ç—É</option>
                <option value="rep">–ü–æ —Ä–µ–ø—É—Ç–∞—Ü–∏–∏</option>
            </select>
        </div>
        <div id="playersList"></div>
    </div>

    <div id="blitzPage" class="page">
        <div style="background: var(--card); padding: 20px; border-radius: 20px; margin-bottom: 20px;">
            <select id="blitzSelect" onchange="loadBlitz()"><option value="">–í—ã–±—Ä–∞—Ç—å —É—Ä–æ–≤–µ–Ω—å...</option></select>
            <div id="blitzAdmin" style="display:none">
                <input type="text" id="blitzTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è">
                <input type="text" id="blitzNodes" placeholder="–°—Ç–∞—Ä—Ç-–ø–æ–∑—ã —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª">
                <button onclick="createBlitz()" style="width:100%">–°–û–ó–î–ê–¢–¨</button>
            </div>
        </div>
        <div id="blitzGame"></div>
    </div>

    <div id="authPage" class="page">
        <div id="authForm">
            <input type="text" id="logN" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="logP" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="handleAuth('login')">–í–æ–π—Ç–∏</button>
            <button onclick="handleAuth('reg')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
        <div id="profileArea" style="display:none">
            <img id="myAv" src="" style="width:150px; height:150px; border-radius: 50%; border: 3px solid var(--accent); cursor: pointer;" onclick="document.getElementById('avFile').click()">
            <input type="file" id="avFile" style="display:none" onchange="updateAvatar(this)">
            <h2 id="myName"></h2>
            <input type="text" id="newN" placeholder="–ù–æ–≤—ã–π –Ω–∏–∫">
            <input type="password" id="newP" placeholder="–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å">
            <button onclick="updateProfile()">–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
            <hr>
            <button onclick="openModal('recModal')" style="width:100%; background:var(--accent); color:#000">–û–¢–ü–†–ê–í–ò–¢–¨ –†–ï–ö–û–†–î</button>
            <button onclick="logout()" style="color:red; border-color:red; margin-top:20px">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div id="lvlModal" class="overlay" onclick="closeModal('lvlModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h2 id="mLvlTitle"></h2>
            <iframe id="mLvlVid" width="100%" height="315" frameborder="0" allowfullscreen></iframe>
            <div id="mLvlRecs" style="margin-top:20px"></div>
            <div id="lvlAdminEdit" class="admin-controls" style="display:none">
                <input type="text" id="editLvlName">
                <input type="text" id="editLvlImg">
                <input type="text" id="editLvlVid">
                <input type="number" id="editLvlPts">
                <button onclick="saveLvlEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button onclick="deleteLvl()" style="color:red">–£–¥–∞–ª–∏—Ç—å —É—Ä–æ–≤–µ–Ω—å</button>
            </div>
        </div>
    </div>

    <div id="chatModal" class="overlay" onclick="closeModal('chatModal')">
        <div id="chatWindow" class="modal" onclick="event.stopPropagation()">
            <h3 id="chatPartnerName">–ß–∞—Ç</h3>
            <div id="chatMessages"></div>
            <div style="display:flex; gap:10px; padding:10px;">
                <input type="text" id="chatInput" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0">
                <button onclick="sendMsg()">></button>
            </div>
        </div>
    </div>

    <div id="recModal" class="overlay" onclick="closeModal('recModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <h2>–†–µ–∫–æ—Ä–¥</h2>
            <input type="text" id="recLvlName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Ä–æ–≤–Ω—è">
            <input type="number" id="recPerc" placeholder="–ü—Ä–æ—Ü–µ–Ω—Ç—ã">
            <input type="text" id="recVid" placeholder="–°—Å—ã–ª–∫–∞ –Ω–∞ –≤–∏–¥–µ–æ">
            <button onclick="submitRecord()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>
    </div>

    <div id="playerModal" class="overlay" onclick="closeModal('playerModal')">
        <div class="modal" onclick="event.stopPropagation()">
            <img id="pAv" src="" style="width:100px; height:100px; border-radius:50%">
            <h2 id="pName"></h2>
            <div id="pRepDisplay" style="font-size:20px; margin-bottom:10px"></div>
            <button onclick="vote(1)">+ –†–µ—Å–ø–µ–∫</button>
            <button onclick="vote(-1)">- –î–∏–∑</button>
            <button onclick="openChat()">–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
            <div id="pAdminTools" class="admin-controls" style="display:none">
                <input type="number" id="admRepInp" placeholder="–£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–µ–ø—É—Ç–∞—Ü–∏—é">
                <button onclick="setRepAdm()">–û–ö</button>
            </div>
            <hr>
            <div id="pRecsList"></div>
        </div>
    </div>
    
    <div id="adminUsersPage" class="page">
        <div id="usersList"></div>
    </div>
    <div id="adminReqPage" class="page">
        <div id="reqsList"></div>
    </div>

    </body>
</html>
<script>
    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø FIREBASE (–ò—Å–ø–æ–ª—å–∑—É–π —Å–≤–æ–π –∫–æ–Ω—Ñ–∏–≥) ---
    const firebaseConfig = {
        apiKey: "AIzaSyC2kE0eAffr3S7tnax0Ym9int4MvNlucg4",
        authDomain: "nouneimlist.firebaseapp.com",
        databaseURL: "https://nouneimlist-default-rtdb.firebaseio.com",
        projectId: "nouneimlist",
        storageBucket: "nouneimlist.firebasestorage.app",
        messagingSenderId: "871712258235",
        appId: "1:871712258235:web:982874240dd587d749119e"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let user = JSON.parse(sessionStorage.getItem('user')) || null;
    let allUsers = {}, levels = {}, currentChatPartner = null;

    // --- –°–õ–£–®–ê–¢–ï–õ–ò –°–û–ë–´–¢–ò–ô ---
    db.ref('users').on('value', s => { 
        allUsers = s.val() || {}; 
        renderPlayers(); 
        renderUsersAdmin();
        if(user && allUsers[user.name]) {
            user = allUsers[user.name];
            updateAccountUI();
        }
    });

    db.ref('levels').on('value', s => { 
        levels = s.val() || {}; 
        renderLevels(); 
    });

    // --- –õ–û–ì–ò–ö–ê –£–†–û–í–ù–ï–ô ---
    function renderLevels() {
        const cont = document.getElementById('levelsList');
        cont.innerHTML = "";
        const sorted = Object.entries(levels).sort((a,b) => b[1].points - a[1].points);
        
        sorted.forEach(([id, l], index) => {
            cont.innerHTML += `
                <div class="level-card" onclick="openLvlDetail('${id}')">
                    <div class="lvl-rank">#${index+1}</div>
                    <img src="${l.img}" class="lvl-img">
                    <div class="lvl-info">
                        <div style="font-size:20px; font-weight:bold">${l.name}</div>
                    </div>
                </div>`;
        });
    }

    function openLvlDetail(id) {
        const l = levels[id];
        document.getElementById('mLvlTitle').innerText = l.name;
        document.getElementById('mLvlVid').src = l.video.replace("watch?v=", "embed/");
        
        let recsHtml = "<h4>–†–ï–ö–û–†–î–´:</h4>";
        if(l.records) {
            Object.entries(l.records).forEach(([rid, r]) => {
                recsHtml += `
                    <div style="display:flex; justify-content:space-between; padding:5px; border-bottom:1px solid #222">
                        <span onclick="openPlayerProfile('${r.name}')" style="cursor:pointer; color:var(--accent)">${r.name}</span>
                        <span>${r.percent}%</span>
                        <a href="${r.video}" target="_blank">üé¨ –í–∏–¥–µ–æ</a>
                    </div>`;
            });
        }
        document.getElementById('mLvlRecs').innerHTML = recsHtml;
        
        // –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
        if(user && (user.role === 'admin' || user.role === 'mod')) {
            document.getElementById('lvlAdminEdit').style.display = 'block';
            document.getElementById('editLvlName').value = l.name;
            // ... –ø–æ–¥–≥—Ä—É–∑–∫–∞ –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –¥–ª—è –ø—Ä–∞–≤–∫–∏
        }
        openModal('lvlModal');
    }

    // --- –õ–û–ì–ò–ö–ê –ò–ì–†–û–ö–û–í –ò –°–û–†–¢–ò–†–û–í–ö–ê ---
    function renderPlayers() {
        const sortType = document.getElementById('playerSort').value;
        const cont = document.getElementById('playersList');
        cont.innerHTML = "";
        
        let playerArray = Object.values(allUsers).map(u => {
            let pts = 0;
            // –°—á–∏—Ç–∞–µ–º –±–∞–ª–ª—ã –ø–æ 100% —Ä–µ–∫–æ—Ä–¥–∞–º
            Object.values(levels).forEach(l => {
                if(l.records) Object.values(l.records).forEach(r => {
                    if(r.name === u.name && r.percent == 100) pts += parseInt(l.points);
                });
            });
            return {...u, totalPts: pts};
        });

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
        if(sortType === 'pts') playerArray.sort((a,b) => b.totalPts - a.totalPts);
        if(sortType === 'rep') playerArray.sort((a,b) => (b.rep||0) - (a.rep||0));

        playerArray.forEach((p, i) => {
            cont.innerHTML += `
                <div class="card-item" onclick="openPlayerProfile('${p.name}')" style="display:flex; align-items:center; padding:10px; margin-bottom:10px; background:var(--card); border-radius:12px;">
                    <div style="width:40px">#${i+1}</div>
                    <img src="${p.avatar || ''}" class="avatar-small">
                    <div class="info">
                        <b>${p.name}</b>
                        <div style="font-size:12px; color:gray">REP: ${p.rep || 0} | PTS: ${p.totalPts}</div>
                    </div>
                </div>`;
        });
    }

    // --- –ß–ê–¢ –ò –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø ---
    function openChat() {
        currentChatPartner = document.getElementById('pName').innerText;
        document.getElementById('chatPartnerName').innerText = "–ß–∞—Ç —Å " + currentChatPartner;
        closeModal('playerModal');
        openModal('chatModal');
        loadMessages();
    }

    function loadMessages() {
        const chatId = [user.name, currentChatPartner].sort().join("_");
        db.ref('chats/' + chatId).on('value', s => {
            const cont = document.getElementById('chatMessages');
            cont.innerHTML = "";
            s.forEach(c => {
                const m = c.val();
                const type = m.from === user.name ? 'my' : 'other';
                cont.innerHTML += `<div class="msg ${type}">${m.text}</div>`;
            });
            cont.scrollTop = cont.scrollHeight;
        });
    }

    function sendMsg() {
        const text = document.getElementById('chatInput').value;
        if(!text || !currentChatPartner) return;
        const chatId = [user.name, currentChatPartner].sort().join("_");
        db.ref('chats/' + chatId).push({ from: user.name, text: text, time: Date.now() });
        // –°–æ–∑–¥–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –¥–ª—è –ø–æ–ª—É—á–∞—Ç–µ–ª—è
        db.ref('notifs/' + currentChatPartner).set({ from: user.name, text: "–Ω–∞–ø–∏—Å–∞–ª —Ç–µ–±–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!" });
        document.getElementById('chatInput').value = "";
    }

    // –°–ª—É—à–∞—Ç–µ–ª—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —é–∑–µ—Ä–∞
    if(user) {
        db.ref('notifs/' + user.name).on('value', s => {
            if(s.exists()) {
                const n = s.val();
                const box = document.getElementById('notifBox');
                box.innerHTML = `<div class="notif-item"><b>${n.from}</b> ${n.text}</div>`;
                setTimeout(() => { box.innerHTML = ""; db.ref('notifs/'+user.name).remove(); }, 5000);
            }
        });
    }

    // --- –ë–õ–ò–¶–ö–†–ò–ì (Stages Logic) ---
    function createBlitz() {
        const title = document.getElementById('blitzTitle').value;
        const nodes = document.getElementById('blitzNodes').value.split(' ').map(Number).sort((a,b)=>a-b);
        if(!title || nodes.length < 1) return;
        db.ref('blitz').push({ title, nodes });
    }

    function loadBlitz() {
        // ... (–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –ø—Ä–µ–¥—ã–¥—É—â–µ–º—É –∫–æ–¥—É, –Ω–æ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ç–∞–¥–∏–∏)
        // –õ–æ–≥–∏–∫–∞: –µ—Å–ª–∏ pts = [20, 40], —Å—Ç–∞–¥–∏–∏ –±—É–¥—É—Ç 1) 0-20, 20-40, 40-100; 2) 0-40, 20-100; 3) 0-100.
    }

    // --- –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ---
    function showPage(id) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    function handleAuth(mode) {
        const n = document.getElementById('logN').value;
        const p = document.getElementById('logP').value;
        if(mode === 'reg') {
            db.ref('users/'+n).set({name:n, pass:p, role:'user', rep:0, avatar:''});
        } else {
            const u = allUsers[n];
            if(u && u.pass === p) {
                sessionStorage.setItem('user', JSON.stringify(u));
                location.reload();
            }
        }
    }

    function updateAccountUI() {
        if(user) {
            document.getElementById('authForm').style.display = 'none';
            document.getElementById('profileArea').style.display = 'block';
            document.getElementById('myName').innerText = user.name;
            document.getElementById('myAv').src = user.avatar || 'https://i.imgur.com/6VBx3io.png';
            if(user.role === 'admin') {
                document.getElementById('adminReqBtn').style.display = 'block';
                document.getElementById('adminUsersBtn').style.display = 'block';
                document.getElementById('blitzAdmin').style.display = 'block';
            }
        }
    }

    function updateAvatar(input) {
        const reader = new FileReader();
        reader.onload = (e) => {
            db.ref('users/' + user.name).update({ avatar: e.target.result });
        };
        reader.readAsDataURL(input.files[0]);
    }
</script>
